<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘å€‘çš„é›²ç«¯è¨˜å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-tab { background-color: #0f172a !important; color: #ffffff !important; }
        .inactive-tab { color: #94a3b8 !important; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-up { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const DB_KEY = "STABLE_LEDGER_V5"; 

        const DEFAULT_CATEGORIES = [
            { id: 'c1', name: 'é¤é£²', icon: 'ðŸ²', color: 'bg-orange-400' },
            { id: 'c2', name: 'äº¤é€š', icon: 'ðŸš—', color: 'bg-blue-400' },
            { id: 'c3', name: 'å±…å®¶', icon: 'ðŸ ', color: 'bg-emerald-400' },
            { id: 'c4', name: 'å¨›æ¨‚', icon: 'ðŸŽ®', color: 'bg-purple-400' },
            { id: 'c5', name: 'è³¼ç‰©', icon: 'ðŸ›ï¸', color: 'bg-rose-400' }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('calendar');
            const [roomId, setRoomId] = useState(new URLSearchParams(window.location.search).get('room') || 'æˆ‘å€‘çš„å®¶');
            const [nickname, setNickname] = useState(localStorage.getItem('ledger_nick') || 'å¦ä¸€åŠ');
            const [roomData, setRoomData] = useState({ transactions: [], categories: DEFAULT_CATEGORIES, fixedExpenses: [] });
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [showAdd, setShowAdd] = useState(false);
            const [selCat, setSelCat] = useState('c1');

            useEffect(() => {
                signInAnonymously(auth);
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !roomId) return;
                const url = new URL(window.location);
                url.searchParams.set('room', roomId);
                window.history.replaceState({}, '', url);

                const roomRef = doc(db, 'artifacts', DB_KEY, 'public', 'data', 'rooms', roomId);
                return onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) setRoomData(snap.data());
                    else setDoc(roomRef, { transactions: [], categories: DEFAULT_CATEGORIES, fixedExpenses: [] });
                });
            }, [user, roomId]);

            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            const calendarDays = useMemo(() => {
                const y = currentMonth.getFullYear();
                const m = currentMonth.getMonth();
                const first = new Date(y, m, 1).getDay();
                const total = new Date(y, m + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < first; i++) days.push(null);
                for (let i = 1; i <= total; i++) days.push(new Date(y, m, i));
                return days;
            }, [currentMonth]);

            const dayTxs = (roomData.transactions || []).filter(t => t.dateKey === formatDate(selectedDate));
            const monthTotal = (roomData.transactions || [])
                .filter(t => t.dateKey.startsWith(`${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`))
                .reduce((s, t) => s + t.amount, 0);

            const handleAdd = async (e) => {
                e.preventDefault();
                const amt = e.target.amount.value;
                if (!amt) return;
                const newTx = {
                    id: Date.now().toString(),
                    user: nickname,
                    amount: parseFloat(amt),
                    categoryId: selCat,
                    note: e.target.note.value || roomData.categories.find(c => c.id === selCat).name,
                    dateKey: formatDate(selectedDate),
                    at: Date.now()
                };
                const roomRef = doc(db, 'artifacts', DB_KEY, 'public', 'data', 'rooms', roomId);
                await updateDoc(roomRef, { transactions: [newTx, ...(roomData.transactions || [])] });
                setShowAdd(false);
            };

            return React.createElement('div', { className: "max-w-md mx-auto min-h-screen pb-24" },
                // Header
                React.createElement('header', { className: "bg-white p-6 pt-12 rounded-b-[2.5rem] shadow-sm flex justify-between items-center sticky top-0 z-40" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('div', { className: "w-10 h-10 bg-rose-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-rose-100" }, 
                            React.createElement('i', { 'data-lucide': 'heart', fill: 'white', size: 20 })
                        ),
                        React.createElement('div', null,
                            React.createElement('h1', { className: "text-base font-black" }, roomId),
                            React.createElement('p', { className: "text-[10px] text-emerald-500 font-bold" }, "â— é›²ç«¯é€£ç·šä¸­")
                        )
                    ),
                    React.createElement('button', { 
                        onClick: () => { navigator.clipboard.writeText(window.location.href); alert("é€£çµå·²è¤‡è£½ï¼"); },
                        className: "p-3 bg-slate-900 text-white rounded-2xl" 
                    }, React.createElement('i', { 'data-lucide': 'share-2', size: 18 }))
                ),

                // Main Content
                React.createElement('main', { className: "p-4" },
                    activeTab === 'calendar' && React.createElement('div', { className: "animate-up" },
                        React.createElement('div', { className: "bg-white p-5 rounded-[2.5rem] shadow-sm mb-6" },
                            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                                React.createElement('button', { onClick: () => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1))) }, React.createElement('i', { 'data-lucide': 'chevron-left' })),
                                React.createElement('span', { className: "font-black" }, `${currentMonth.getFullYear()}å¹´ ${currentMonth.getMonth()+1}æœˆ`),
                                React.createElement('button', { onClick: () => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1))) }, React.createElement('i', { 'data-lucide': 'chevron-right' }))
                            ),
                            React.createElement('div', { className: "calendar-grid mb-2" }, ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => React.createElement('div', { key: d, className: "text-center text-[10px] font-black text-slate-300" }, d))),
                            React.createElement('div', { className: "calendar-grid" },
                                calendarDays.map((date, i) => {
                                    if (!date) return React.createElement('div', { key: i });
                                    const isSel = formatDate(date) === formatDate(selectedDate);
                                    const hasData = (roomData.transactions || []).some(t => t.dateKey === formatDate(date));
                                    return React.createElement('button', {
                                        key: i, onClick: () => setSelectedDate(date),
                                        className: `aspect-square rounded-2xl flex items-center justify-center text-sm font-bold relative ${isSel ? 'bg-slate-900 text-white' : 'hover:bg-slate-50'}`
                                    }, date.getDate(), hasData && !isSel && React.createElement('div', { className: "absolute bottom-1 w-1 h-1 bg-rose-400 rounded-full" }));
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-between items-center mb-4 px-2" },
                            React.createElement('span', { className: "text-[10px] font-black text-slate-400 uppercase tracking-widest" }, formatDate(selectedDate)),
                            React.createElement('button', { onClick: () => setShowAdd(true), className: "bg-rose-500 text-white p-4 rounded-2xl shadow-xl shadow-rose-100" }, React.createElement('i', { 'data-lucide': 'plus' }))
                        ),
                        dayTxs.length === 0 ? React.createElement('div', { className: "py-12 text-center text-slate-300 text-xs font-bold" }, "ä»Šå¤©é‚„æ²’è¨˜å¸³å–” â˜•") :
                        dayTxs.map(t => {
                            const cat = roomData.categories.find(c => c.id === t.categoryId) || DEFAULT_CATEGORIES[0];
                            return React.createElement('div', { key: t.id, className: "bg-white p-4 rounded-3xl flex justify-between items-center mb-3 shadow-sm" },
                                React.createElement('div', { className: "flex items-center gap-3" },
                                    React.createElement('div', { className: `w-10 h-10 ${cat.color} bg-opacity-10 text-xl rounded-xl flex items-center justify-center` }, cat.icon),
                                    React.createElement('div', null, React.createElement('p', { className: "font-black text-sm" }, t.note), React.createElement('p', { className: "text-[9px] text-slate-400" }, t.user))
                                ),
                                React.createElement('p', { className: "font-black text-lg" }, `$${t.amount}`)
                            );
                        })
                    ),
                    activeTab === 'stats' && React.createElement('div', { className: "animate-up bg-white p-8 rounded-[2.5rem] shadow-sm text-center" },
                        React.createElement('p', { className: "text-[10px] font-black text-slate-400 mb-2" }, "æœ¬æœˆç´¯è¨ˆæ”¯å‡º"),
                        React.createElement('p', { className: "text-4xl font-black mb-8" }, `$${monthTotal.toLocaleString()}`),
                        React.createElement('div', { className: "space-y-4" },
                            roomData.categories.map(cat => {
                                const total = (roomData.transactions || []).filter(t => t.categoryId === cat.id && t.dateKey.startsWith(`${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`)).reduce((s,t)=>s+t.amount,0);
                                if (total === 0) return null;
                                return React.createElement('div', { key: cat.id },
                                    React.createElement('div', { className: "flex justify-between text-xs font-bold mb-1" }, React.createElement('span', null, `${cat.icon} ${cat.name}`), React.createElement('span', null, `$${total}`)),
                                    React.createElement('div', { className: "h-2 bg-slate-50 rounded-full overflow-hidden" }, React.createElement('div', { className: `${cat.color} h-full`, style: { width: `${(total/monthTotal)*100}%` } }))
                                );
                            })
                        )
                    ),
                    activeTab === 'settings' && React.createElement('div', { className: "animate-up space-y-4" },
                        React.createElement('div', { className: "bg-white p-6 rounded-[2.5rem] shadow-sm space-y-4" },
                            React.createElement('div', null, React.createElement('label', { className: "text-[10px] font-black text-slate-400 px-2" }, "æˆ‘çš„æš±ç¨±"), React.createElement('input', { value: nickname, onChange: e => { setNickname(e.target.value); localStorage.setItem('ledger_nick', e.target.value); }, className: "w-full p-4 bg-slate-50 rounded-2xl font-black mt-1 outline-none" })),
                            React.createElement('div', null, React.createElement('label', { className: "text-[10px] font-black text-slate-400 px-2" }, "æˆ¿é–“åç¨±"), React.createElement('input', { value: roomId, onChange: e => setRoomId(e.target.value), className: "w-full p-4 bg-slate-50 rounded-2xl font-black mt-1 outline-none" }))
                        )
                    )
                ),

                // Nav
                React.createElement('nav', { className: "fixed bottom-8 left-1/2 -translate-x-1/2 bg-white p-2 rounded-full flex gap-1 shadow-2xl z-50 border border-slate-100" },
                    [
                        { id: 'calendar', icon: 'calendar', label: 'è¨˜å¸³' },
                        { id: 'stats', icon: 'pie-chart', label: 'åˆ†æž' },
                        { id: 'settings', icon: 'settings', label: 'è¨­å®š' }
                    ].map(t => React.createElement('button', {
                        key: t.id, onClick: () => setActiveTab(t.id),
                        className: `flex items-center gap-2 px-6 py-3 rounded-full transition-all ${activeTab === t.id ? 'active-tab shadow-lg' : 'inactive-tab'}`
                    }, React.createElement('i', { 'data-lucide': t.icon, size: 18 }), activeTab === t.id && React.createElement('span', { className: "text-xs font-black" }, t.label)))
                ),

                // Modal
                showAdd && React.createElement('div', { className: "fixed inset-0 z-[100] flex items-end justify-center p-4 animate-in fade-in" },
                    React.createElement('div', { className: "absolute inset-0 bg-slate-900/60 backdrop-blur-sm", onClick: () => setShowAdd(false) }),
                    React.createElement('form', { onSubmit: handleAdd, className: "relative bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl animate-up" },
                        React.createElement('h3', { className: "font-black text-center mb-6" }, "æ–°å¢žæ”¯å‡º"),
                        React.createElement('input', { name: "amount", type: "number", placeholder: "0", autoFocus: true, className: "w-full text-5xl font-black text-center mb-6 outline-none" }),
                        React.createElement('div', { className: "grid grid-cols-5 gap-2 mb-6" },
                            roomData.categories.map(c => React.createElement('button', { key: c.id, type: "button", onClick: () => setSelCat(c.id), className: `aspect-square rounded-2xl flex items-center justify-center text-xl transition-all ${selCat === c.id ? 'bg-slate-900 text-white scale-110 shadow-lg' : 'bg-slate-50'}` }, c.icon))
                        ),
                        React.createElement('input', { name: "note", placeholder: "å‚™è¨»...", className: "w-full p-4 bg-slate-50 rounded-2xl font-black mb-6 outline-none" }),
                        React.createElement('button', { type: "submit", className: "w-full py-5 bg-rose-500 text-white rounded-3xl font-black shadow-lg" }, "å„²å­˜")
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        setInterval(() => lucide.createIcons(), 500);
    </script>
</body>
</html>

