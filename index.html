<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ä¾¶é›²ç«¯åŒæ­¥è¨˜å¸³</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        .active-tab { background-color: #1e293b !important; color: white !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .modal-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        input { border: none; outline: none; background: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Firebase Configuration From Environment
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'stable-account-v1';
        
        if (firebaseConfig.apiKey && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }

        const DEFAULT_CATS = [
            { id: 'c1', name: 'é¤é£²', icon: 'ğŸ²' },
            { id: 'c2', name: 'äº¤é€š', icon: 'ğŸš—' },
            { id: 'c3', name: 'å±…å®¶', icon: 'ğŸ ' },
            { id: 'c4', name: 'è³¼ç‰©', icon: 'ğŸ›ï¸' },
            { id: 'c5', name: 'å¨›æ¨‚', icon: 'ğŸ®' }
        ];

        function App() {
            const params = new URLSearchParams(window.location.search);
            const urlRoom = params.get('room');

            const [activeTab, setActiveTab] = useState('book');
            const [roomName, setRoomName] = useState(urlRoom || localStorage.getItem('room_id') || 'æˆ‘å€‘çš„å®¶');
            const [userName, setUserName] = useState(localStorage.getItem('user_nick') || 'ç”¨æˆ¶A');
            const [viewUser, setViewUser] = useState('all'); 
            const [user, setUser] = useState(null);
            
            const [dbData, setDbData] = useState({ transactions: [], categories: DEFAULT_CATS, recurring: [] });
            const [loading, setLoading] = useState(true);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [showAdd, setShowAdd] = useState(false);

            // Form States
            const [amt, setAmt] = useState('');
            const [note, setNote] = useState('');
            const [selCatId, setSelCatId] = useState('c1');
            const [isIncome, setIsIncome] = useState(false);
            const [recForm, setRecForm] = useState({ name: '', amt: '', day: '1' });
            const [newCat, setNewCat] = useState({ name: '', icon: 'ğŸ’°' });

            const dateStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            // Rule 3: Auth First
            useEffect(() => {
                const auth = firebase.auth();
                const initAuth = async () => {
                    try {
                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                            await auth.signInWithCustomToken(window.__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (e) {
                        console.error("Auth Failure", e);
                    }
                };
                initAuth();
                const unsub = auth.onAuthStateChanged(u => {
                    setUser(u);
                    if (!firebaseConfig.apiKey) setLoading(false);
                });
                return () => unsub();
            }, []);

            // Rule 1: Strict Paths for Firestore
            useEffect(() => {
                if (!user || !firebaseConfig.apiKey) return;
                
                const db = firebase.firestore();
                // path: /artifacts/{appId}/public/data/rooms/{roomName}
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName);
                
                const unsub = docRef.onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setDbData({
                            transactions: data.transactions || [],
                            categories: data.categories || DEFAULT_CATS,
                            recurring: data.recurring || []
                        });
                    } else {
                        // Initialize new room
                        docRef.set({ transactions: [], categories: DEFAULT_CATS, recurring: [] });
                    }
                    setLoading(false);
                }, (err) => {
                    console.error("Sync Error:", err);
                    setLoading(false);
                });

                localStorage.setItem('room_id', roomName);
                return () => unsub();
            }, [user, roomName]);

            const updateCloud = async (newData) => {
                setDbData(newData);
                if (user && firebaseConfig.apiKey) {
                    const db = firebase.firestore();
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName);
                    try {
                        await docRef.set(newData, { merge: true });
                    } catch (e) {
                        console.error("Cloud Update Failure", e);
                    }
                }
            };

            const allUsers = useMemo(() => {
                const s = new Set(dbData.transactions.map(t => t.user));
                s.add(userName);
                return Array.from(s);
            }, [dbData.transactions, userName]);

            const dailyLogs = useMemo(() => {
                const logs = dbData.transactions.filter(t => t.date === dateStr(selectedDate));
                const recs = dbData.recurring.filter(r => parseInt(r.day) === selectedDate.getDate());
                const combined = [...logs, ...recs.map(r => ({ ...r, isRec: true }))];
                return viewUser === 'all' ? combined : combined.filter(t => t.user === viewUser);
            }, [dbData, selectedDate, viewUser]);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (activeTab === 'chart' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
                    
                    const mLogs = dbData.transactions.filter(t => {
                        const d = new Date(t.date);
                        return d.getFullYear() === y && d.getMonth() === m && (viewUser === 'all' || t.user === viewUser);
                    }).filter(t => t.amount < 0);

                    const groups = {};
                    mLogs.forEach(t => {
                        const c = dbData.categories.find(cat => cat.id === t.catId)?.name || 'å…¶ä»–';
                        groups[c] = (groups[c] || 0) + Math.abs(t.amount);
                    });

                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(groups),
                            datasets: [{ 
                                data: Object.values(groups), 
                                backgroundColor: ['#f43f5e', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4'], 
                                borderWidth: 0 
                            }]
                        },
                        options: { 
                            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold', size: 12 } } } },
                            cutout: '75%',
                            maintainAspectRatio: false
                        }
                    });
                }
            }, [activeTab, dbData, currentMonth, viewUser]);

            const handleShare = () => {
                const url = `${window.location.origin}${window.location.pathname}?room=${encodeURIComponent(roomName)}`;
                const tempInput = document.createElement("input");
                tempInput.value = url;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                alert("å·²è¤‡è£½å°ˆå±¬é‚€è«‹é€£çµï¼");
            };

            return (
                <div className="max-w-md mx-auto min-h-screen pb-32">
                    {/* Header */}
                    <header className="bg-white p-6 pt-12 rounded-b-[2.5rem] shadow-sm sticky top-0 z-40">
                        <div className="flex justify-between items-center mb-6 px-2">
                            <div>
                                <h1 className="font-black text-slate-900 text-2xl tracking-tighter">ğŸ  {roomName}</h1>
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Cloud Syncing Enabled</p>
                            </div>
                            <div className={`w-3 h-3 rounded-full ${loading ? 'bg-amber-400 animate-pulse' : 'bg-emerald-400'}`} />
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            <button onClick={() => setViewUser('all')} className={`px-6 py-3 rounded-2xl text-[11px] font-black whitespace-nowrap transition-all ${viewUser === 'all' ? 'bg-slate-900 text-white shadow-xl' : 'bg-slate-100 text-slate-400'}`}>å…¨éƒ¨æ˜ç´°</button>
                            {allUsers.map(u => (
                                <button key={u} onClick={() => setViewUser(u)} className={`px-6 py-3 rounded-2xl text-[11px] font-black whitespace-nowrap transition-all ${viewUser === u ? 'bg-rose-500 text-white shadow-xl' : 'bg-slate-100 text-slate-400'}`}>
                                    {u === userName ? 'æˆ‘' : u}
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="p-4 space-y-6">
                        {activeTab === 'book' && (
                            <>
                                {/* Calendar Section */}
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm">
                                    <div className="flex justify-between items-center mb-6 px-4 font-black text-slate-900">
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1))} className="p-2">â€¹</button>
                                        <span className="text-sm tracking-widest">{currentMonth.getFullYear()} / {currentMonth.getMonth()+1}</span>
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1))} className="p-2">â€º</button>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1">
                                        {Array.from({length: new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay()}).map((_,i)=><div key={i}/>)}
                                        {Array.from({length: new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0).getDate()}).map((_,i)=>{
                                            const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i+1);
                                            const isSel = dateStr(d) === dateStr(selectedDate);
                                            const hasTx = dbData.transactions.some(t => t.date === dateStr(d)) || dbData.recurring.some(r => parseInt(r.day) === d.getDate());
                                            return (
                                                <button key={i} onClick={() => setSelectedDate(d)} className={`aspect-square rounded-2xl flex flex-col items-center justify-center text-xs font-black relative transition-all ${isSel ? 'bg-slate-900 text-white shadow-2xl scale-110 z-10' : 'text-slate-600 hover:bg-slate-50'}`}>
                                                    {i+1}
                                                    {hasTx && !isSel && <div className="absolute bottom-2 w-1 h-1 bg-rose-500 rounded-full" />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* List Section */}
                                <div className="space-y-4">
                                    <div className="flex justify-between items-center px-4">
                                        <h2 className="text-[10px] font-black text-slate-400 tracking-[0.25em]">{dateStr(selectedDate)}</h2>
                                        <button onClick={() => setShowAdd(true)} className="bg-rose-500 text-white px-8 py-4 rounded-2xl text-xs font-black shadow-lg shadow-rose-200 active:scale-95 transition-all">ï¼‹ è¨˜ä¸€ç­†</button>
                                    </div>
                                    {dailyLogs.length === 0 ? (
                                        <div className="py-24 text-center text-slate-300 font-bold text-xs uppercase tracking-widest italic">é€™å¤©æ²’æœ‰å¸³ç›®å–”</div>
                                    ) : (
                                        dailyLogs.map(t => (
                                            <div key={t.id} className="bg-white p-5 rounded-[2.2rem] flex justify-between items-center shadow-sm border border-slate-50 hover:border-slate-200 transition-colors">
                                                <div className="flex items-center gap-4">
                                                    <div className="text-2xl w-14 h-14 bg-slate-50 rounded-2xl flex items-center justify-center">
                                                        {t.isRec ? 'ğŸ”„' : (dbData.categories.find(c => c.id === t.catId)?.icon || 'ğŸ’°')}
                                                    </div>
                                                    <div>
                                                        <p className="font-black text-slate-800 text-sm">{t.note || t.name}</p>
                                                        <p className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">{t.user} {t.isRec ? '| å›ºå®šæ”¶æ”¯' : ''}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className={`font-black text-lg ${t.amount > 0 ? 'text-emerald-500' : 'text-slate-900'}`}>
                                                        {t.amount > 0 ? `+$${t.amount}` : `-$${Math.abs(t.amount)}`}
                                                    </p>
                                                    {!t.isRec && (
                                                        <button onClick={() => updateCloud({...dbData, transactions: dbData.transactions.filter(i => i.id !== t.id)})} className="text-[10px] text-rose-300 font-bold px-2 py-1">åˆªé™¤</button>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'chart' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-white p-10 rounded-[3rem] shadow-sm text-center relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-rose-500 to-indigo-500" />
                                    <h3 className="font-black text-slate-400 text-[10px] uppercase tracking-widest mb-8">æ”¯å‡ºæ¯”ä¾‹åˆ†æ</h3>
                                    <div className="relative mx-auto w-full h-72">
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-emerald-500 p-8 rounded-[2.5rem] text-white shadow-xl shadow-emerald-100">
                                        <p className="text-[9px] font-bold uppercase opacity-80 mb-2">æœ¬æœˆç¸½æ”¶å…¥</p>
                                        <p className="text-3xl font-black">${dbData.transactions.filter(t => {
                                            const d = new Date(t.date);
                                            return d.getMonth() === currentMonth.getMonth() && t.amount > 0;
                                        }).reduce((a,b)=>a+b.amount, 0)}</p>
                                    </div>
                                    <div className="bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-xl shadow-slate-200">
                                        <p className="text-[9px] font-bold uppercase opacity-80 mb-2">æœ¬æœˆç¸½æ”¯å‡º</p>
                                        <p className="text-3xl font-black">${Math.abs(dbData.transactions.filter(t => {
                                            const d = new Date(t.date);
                                            return d.getMonth() === currentMonth.getMonth() && t.amount < 0;
                                        }).reduce((a,b)=>a+b.amount, 0))}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-6">
                                    <h3 className="font-black text-slate-900 text-lg">æˆ¿é–“è¨­ç½®</h3>
                                    <button onClick={handleShare} className="w-full bg-indigo-600 text-white p-5 rounded-2xl font-black text-sm shadow-xl shadow-indigo-100 flex items-center justify-center gap-3">
                                        <span>ğŸ”—</span> åˆ†äº«æ­¤æˆ¿é–“çµ¦ä¼´ä¾¶
                                    </button>
                                    <div className="space-y-5 pt-4 border-t border-slate-50">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 ml-2 uppercase tracking-widest">æˆ‘çš„é¡¯ç¤ºæš±ç¨±</label>
                                            <input value={userName} onChange={e=>{setUserName(e.target.value); localStorage.setItem('user_nick', e.target.value);}} className="w-full p-5 bg-slate-50 rounded-2xl font-bold mt-2 focus:bg-slate-100 transition-colors" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 ml-2 uppercase tracking-widest">æˆ¿é–“ ID (åŒæ­¥é—œéµå­—)</label>
                                            <input value={roomName} onChange={e=>setRoomName(e.target.value)} className="w-full p-5 bg-rose-50 rounded-2xl font-bold mt-2 text-rose-600 border border-rose-100" />
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-6">
                                    <h3 className="font-black text-slate-900 text-lg">å›ºå®šæ”¶æ”¯è¨­å®š</h3>
                                    <div className="space-y-3">
                                        <div className="flex gap-2">
                                            <input placeholder="é …ç›®çš„åç¨±" className="flex-1 p-5 bg-slate-50 rounded-2xl font-bold text-xs" value={recForm.name} onChange={e=>setRecForm({...recForm, name:e.target.value})} />
                                            <input type="number" placeholder="é‡‘é¡" className="w-28 p-5 bg-slate-50 rounded-2xl font-bold text-xs" value={recForm.amt} onChange={e=>setRecForm({...recForm, amt:e.target.value})} />
                                        </div>
                                        <div className="flex gap-2 items-center">
                                            <span className="text-[10px] font-black text-slate-400 pl-2">æ¯æœˆå¹¾è™Ÿæ‰£æ¬¾ï¼Ÿ</span>
                                            <input type="number" min="1" max="31" value={recForm.day} onChange={e=>setRecForm({...recForm, day:e.target.value})} className="w-20 p-5 bg-slate-50 rounded-2xl font-bold text-center" />
                                            <button onClick={()=>{
                                                if(!recForm.name || !recForm.amt) return;
                                                const nr = { id: 'r'+Date.now(), name: recForm.name, amount: -Math.abs(recForm.amt), day: recForm.day, user: userName };
                                                updateCloud({...dbData, recurring: [...dbData.recurring, nr]});
                                                setRecForm({name:'', amt:'', day:'1'});
                                            }} className="flex-1 bg-slate-900 text-white p-5 rounded-2xl font-black text-xs">æ–°å¢è‡³åˆ—è¡¨</button>
                                        </div>
                                    </div>
                                    <div className="space-y-2 pt-2">
                                        {dbData.recurring.map(r => (
                                            <div key={r.id} className="flex justify-between items-center p-5 bg-slate-50 rounded-2xl text-[11px] font-black">
                                                <span className="text-slate-700">{r.name} (æ¯æœˆ {r.day} è™Ÿ) - ${Math.abs(r.amount)}</span>
                                                <button onClick={()=>updateCloud({...dbData, recurring: dbData.recurring.filter(i=>i.id!==r.id)})} className="text-rose-400 px-2">ç§»é™¤</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-2xl p-2.5 rounded-[3rem] flex gap-2 shadow-2xl z-50 border border-white/50">
                        <button onClick={() => setActiveTab('book')} className={`flex items-center gap-3 px-10 py-5 rounded-full transition-all ${activeTab === 'book' ? 'active-tab shadow-xl scale-105' : 'text-slate-300'}`}>
                            <span className="text-xl">ğŸ“…</span>
                            {activeTab === 'book' && <span className="text-xs font-black">å¸³ç°¿</span>}
                        </button>
                        <button onClick={() => setActiveTab('chart')} className={`flex items-center gap-3 px-10 py-5 rounded-full transition-all ${activeTab === 'chart' ? 'active-tab shadow-xl scale-105' : 'text-slate-300'}`}>
                            <span className="text-xl">ğŸ“Š</span>
                            {activeTab === 'chart' && <span className="text-xs font-black">åˆ†æ</span>}
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex items-center gap-3 px-10 py-5 rounded-full transition-all ${activeTab === 'settings' ? 'active-tab shadow-xl scale-105' : 'text-slate-300'}`}>
                            <span className="text-xl">âš™ï¸</span>
                            {activeTab === 'settings' && <span className="text-xs font-black">è¨­å®š</span>}
                        </button>
                    </nav>

                    {/* Transaction Modal */}
                    {showAdd && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/80 backdrop-blur-md" onClick={() => setShowAdd(false)} />
                            <div className="relative bg-white w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl modal-up">
                                <div className="flex justify-center mb-10">
                                    <div className="bg-slate-100 p-1.5 rounded-2xl flex">
                                        <button onClick={() => setIsIncome(false)} className={`px-10 py-3 rounded-xl text-xs font-black transition-all ${!isIncome ? 'bg-white text-rose-500 shadow-sm' : 'text-slate-400'}`}>æ”¯å‡º</button>
                                        <button onClick={() => setIsIncome(true)} className={`px-10 py-3 rounded-xl text-xs font-black transition-all ${isIncome ? 'bg-white text-emerald-500 shadow-sm' : 'text-slate-400'}`}>æ”¶å…¥</button>
                                    </div>
                                </div>
                                <div className="text-center mb-10">
                                    <span className="text-2xl font-black text-slate-300 mr-2">$</span>
                                    <input type="number" autoFocus value={amt} onChange={e => setAmt(e.target.value)} placeholder="0" className="text-7xl font-black text-slate-900 w-56 text-center" />
                                </div>
                                <div className="grid grid-cols-4 gap-4 mb-10 max-h-48 overflow-y-auto no-scrollbar">
                                    {dbData.categories.map(c => (
                                        <button key={c.id} onClick={() => setSelCatId(c.id)} className={`aspect-square rounded-3xl text-3xl flex items-center justify-center transition-all ${selCatId === c.id ? 'bg-slate-900 shadow-2xl scale-110' : 'bg-slate-50'}`}>{c.icon}</button>
                                    ))}
                                </div>
                                <input value={note} onChange={e => setNote(e.target.value)} placeholder="å¯«é»å‚™è¨»å§..." className="w-full p-6 bg-slate-50 rounded-3xl font-bold mb-8 text-sm focus:bg-slate-100 transition-colors" />
                                <button onClick={() => {
                                    if(!amt) return;
                                    const nt = { id: 't'+Date.now(), amount: isIncome ? Math.abs(amt) : -Math.abs(amt), note: note || dbData.categories.find(c=>c.id===selCatId)?.name, catId: selCatId, user: userName, date: dateStr(selectedDate) };
                                    updateCloud({...dbData, transactions: [...dbData.transactions, nt]});
                                    setAmt(''); setNote(''); setShowAdd(false);
                                }} className="w-full py-7 bg-slate-900 text-white rounded-[2.5rem] font-black shadow-2xl active:scale-95 transition-all">å„²å­˜é€™ç­†å¸³ç›®</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
