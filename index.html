<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘å€‘çš„é›²ç«¯è¨˜å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .active-tab { background-color: #ffffff !important; color: #0f172a !important; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .inactive-tab { color: #94a3b8 !important; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .category-selected { border: 3px solid #0f172a !important; transform: scale(1.1); background-color: #f1f5f9; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-up { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const DB_KEY = "PRO_LEDGER_FINAL_STABLE_V4"; 

        const DEFAULT_CATEGORIES = [
            { id: 'cat1', name: 'é¤é£²ç¾Žé£Ÿ', icon: 'ðŸ²', color: 'bg-orange-400' },
            { id: 'cat2', name: 'äº¤é€šå‡ºè¡Œ', icon: 'ðŸš—', color: 'bg-blue-400' },
            { id: 'cat3', name: 'å±…å®¶ç”Ÿæ´»', icon: 'ðŸ ', color: 'bg-emerald-400' },
            { id: 'cat4', name: 'ä¼‘é–’å¨›æ¨‚', icon: 'ðŸŽ®', color: 'bg-purple-400' },
            { id: 'cat5', name: 'è³¼ç‰©æ¶ˆè²»', icon: 'ðŸ›ï¸', color: 'bg-rose-400' }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [roomId, setRoomId] = useState(new URLSearchParams(window.location.search).get('room') || 'æˆ‘å€‘çš„å®¶');
            const [nickname, setNickname] = useState(localStorage.getItem('ledger_nick') || 'åŒ¿åä¼´ä¾¶');
            const [roomData, setRoomData] = useState({ transactions: [], categories: DEFAULT_CATEGORIES, fixedExpenses: [] });
            const [activeTab, setActiveTab] = useState('calendar'); 
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [showAddModal, setShowAddModal] = useState(false);
            const [selCatInModal, setSelCatInModal] = useState('cat1');

            useEffect(() => {
                signInAnonymously(auth);
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !roomId) return;
                const url = new URL(window.location);
                url.searchParams.set('room', roomId);
                window.history.replaceState({}, '', url);

                const roomRef = doc(db, 'artifacts', DB_KEY, 'public', 'data', 'rooms', roomId);
                return onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) setRoomData(snap.data());
                    else setDoc(roomRef, { transactions: [], categories: DEFAULT_CATEGORIES, fixedExpenses: [] });
                });
            }, [user, roomId]);

            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            const calendarDays = useMemo(() => {
                const y = currentMonth.getFullYear();
                const m = currentMonth.getMonth();
                const firstDay = new Date(y, m, 1).getDay();
                const totalDays = new Date(y, m + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < firstDay; i++) days.push(null);
                for (let i = 1; i <= totalDays; i++) days.push(new Date(y, m, i));
                return days;
            }, [currentMonth]);

            const dayTxs = (roomData.transactions || []).filter(t => t.dateKey === formatDate(selectedDate));
            const monthStats = useMemo(() => {
                const mStr = `${currentMonth.getFullYear()}-${String(currentMonth.getMonth() + 1).padStart(2, '0')}`;
                const mList = (roomData.transactions || []).filter(t => t.dateKey.startsWith(mStr));
                const total = mList.reduce((s, t) => s + t.amount, 0);
                return { total, mList };
            }, [roomData.transactions, currentMonth]);

            const handleSaveTx = async (e) => {
                e.preventDefault();
                const amount = e.target.amount.value;
                const note = e.target.note.value;
                if (!amount) return;

                const newTx = {
                    id: `tx_${Date.now()}`,
                    user: nickname,
                    amount: parseFloat(amount),
                    categoryId: selCatInModal,
                    note: note || roomData.categories.find(c => c.id === selCatInModal).name,
                    dateKey: formatDate(selectedDate),
                    at: Date.now()
                };
                const roomRef = doc(db, 'artifacts', DB_KEY, 'public', 'data', 'rooms', roomId);
                await updateDoc(roomRef, { transactions: [newTx, ...(roomData.transactions || [])] });
                setShowAddModal(false);
            };

            return React.createElement('div', { className: "max-w-md mx-auto min-h-screen pb-28" },
                // Header
                React.createElement('header', { className: "bg-white p-6 pt-12 rounded-b-[2.5rem] shadow-sm flex justify-between items-center sticky top-0 z-40" },
                    React.createElement('div', { className: "flex items-center gap-3" },
                        React.createElement('div', { className: "w-10 h-10 bg-rose-500 rounded-xl flex items-center justify-center shadow-lg shadow-rose-100" }, 
                            React.createElement('i', { 'data-lucide': 'heart', className: "text-white", fill: "white", size: 20 })
                        ),
                        React.createElement('div', null,
                            React.createElement('h1', { className: "text-lg font-black tracking-tight" }, roomId),
                            React.createElement('p', { className: "text-[10px] text-emerald-500 font-black flex items-center gap-1" }, 
                                React.createElement('span', { className: "w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse" }), "é›²ç«¯é€£ç·šåŒæ­¥ä¸­"
                            )
                        )
                    ),
                    React.createElement('button', { 
                        onClick: () => { navigator.clipboard.writeText(window.location.href); alert("é€£çµå·²è¤‡è£½ï¼"); },
                        className: "p-3 bg-slate-900 text-white rounded-2xl active:scale-90 transition-all" 
                    }, React.createElement('i', { 'data-lucide': 'share-2', size: 18 }))
                ),

                // Content
                React.createElement('main', { className: "p-4" },
                    activeTab === 'calendar' && React.createElement('div', { className: "animate-up" },
                        React.createElement('section', { className: "bg-white p-5 rounded-[2.5rem] shadow-sm mb-6" },
                            React.createElement('div', { className: "flex justify-between items-center mb-6 px-2" },
                                React.createElement('button', { onClick: () => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1))) }, React.createElement('i', { 'data-lucide': 'chevron-left' })),
                                React.createElement('span', { className: "font-black text-slate-800" }, `${currentMonth.getFullYear()}å¹´ ${currentMonth.getMonth()+1}æœˆ`),
                                React.createElement('button', { onClick: () => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1))) }, React.createElement('i', { 'data-lucide': 'chevron-right' }))
                            ),
                            React.createElement('div', { className: "calendar-grid mb-2" },
                                ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => React.createElement('div', { key: d, className: "text-center text-[10px] font-black text-slate-300" }, d))
                            ),
                            React.createElement('div', { className: "calendar-grid" },
                                calendarDays.map((date, i) => {
                                    if (!date) return React.createElement('div', { key: `e-${i}` });
                                    const isSel = formatDate(date) === formatDate(selectedDate);
                                    const hasData = (roomData.transactions || []).some(t => t.dateKey === formatDate(date));
                                    return React.createElement('button', {
                                        key: i,
                                        onClick: () => setSelectedDate(date),
                                        className: `aspect-square rounded-2xl flex items-center justify-center text-sm font-bold relative transition-all ${isSel ? 'bg-slate-900 text-white shadow-xl' : 'hover:bg-rose-50'}`
                                    }, 
                                        date.getDate(),
                                        hasData && !isSel && React.createElement('div', { className: "absolute bottom-1.5 w-1 h-1 bg-rose-400 rounded-full" })
                                    );
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-between items-center px-4 mb-4" },
                            React.createElement('h3', { className: "text-[10px] font-black text-slate-300 uppercase tracking-widest" }, formatDate(selectedDate)),
                            React.createElement('button', { onClick: () => setShowAddModal(true), className: "bg-rose-500 text-white p-4 rounded-2xl shadow-xl shadow-rose-100 active:scale-95" }, 
                                React.createElement('i', { 'data-lucide': 'plus' })
                            )
                        ),
                        dayTxs.length === 0 ? 
                            React.createElement('div', { className: "bg-white/50 border-2 border-dashed border-slate-200 rounded-[2.5rem] py-16 flex flex-col items-center gap-2 text-slate-300" },
                                React.createElement('i', { 'data-lucide': 'coffee', size: 32 }),
                                React.createElement('p', { className: "text-xs font-black" }, "ä»Šå¤©é‚„æ²’æœ‰ç´€éŒ„å–”")
                            ) :
                            dayTxs.map(t => {
                                const cat = roomData.categories.find(c => c.id === t.categoryId) || DEFAULT_CATEGORIES[0];
                                return React.createElement('div', { key: t.id, className: "bg-white p-5 rounded-[2rem] flex items-center justify-between shadow-sm mb-3" },
                                    React.createElement('div', { className: "flex items-center gap-4" },
                                        React.createElement('div', { className: `w-12 h-12 ${cat.color} bg-opacity-10 text-2xl rounded-2xl flex items-center justify-center` }, cat.icon),
                                        React.createElement('div', null,
                                            React.createElement('p', { className: "font-black text-sm" }, t.note),
                                            React.createElement('p', { className: "text-[10px] font-bold text-slate-400" }, `ç”± ${t.user} è¨˜å¸³`)
                                        )
                                    ),
                                    React.createElement('p', { className: "text-lg font-black" }, `$${t.amount.toLocaleString()}`)
                                );
                            })
                    ),

                    activeTab === 'stats' && React.createElement('section', { className: "animate-up bg-white p-8 rounded-[2.5rem] shadow-sm space-y-8" },
                        React.createElement('div', { className: "text-center" },
                            React.createElement('h2', { className: "text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2" }, "æœ¬æœˆæ”¯å‡ºæ¦‚æ³"),
                            React.createElement('p', { className: "text-5xl font-black text-slate-900" }, `$${monthStats.total.toLocaleString()}`)
                        ),
                        React.createElement('div', { className: "space-y-6" },
                            roomData.categories.map(cat => {
                                const catTotal = monthStats.mList.filter(t => t.categoryId === cat.id).reduce((s,t)=>s+t.amount,0);
                                if (catTotal === 0) return null;
                                return React.createElement('div', { key: cat.id },
                                    React.createElement('div', { className: "flex justify-between text-xs font-black mb-2" },
                                        React.createElement('span', null, `${cat.icon} ${cat.name}`),
                                        React.createElement('span', null, `$${catTotal.toLocaleString()}`)
                                    ),
                                    React.createElement('div', { className: "h-2.5 bg-slate-50 rounded-full overflow-hidden" },
                                        React.createElement('div', { className: `${cat.color} h-full transition-all duration-1000`, style: { width: `${(catTotal/monthStats.total)*100}%` } })
                                    )
                                );
                            })
                        )
                    ),

                    activeTab === 'settings' && React.createElement('section', { className: "animate-up space-y-6" },
                        React.createElement('div', { className: "bg-white p-8 rounded-[2.5rem] shadow-sm space-y-6" },
                            React.createElement('div', { className: "space-y-3" },
                                React.createElement('label', { className: "text-[10px] font-black text-slate-300 uppercase px-2" }, "æˆ‘çš„é¡¯ç¤ºæš±ç¨±"),
                                React.createElement('input', { 
                                    value: nickname, 
                                    onChange: (e) => { setNickname(e.target.value); localStorage.setItem('ledger_nick', e.target.value); },
                                    className: "w-full p-4 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-rose-100"
                                })
                            ),
                            React.createElement('div', { className: "space-y-3" },
                                React.createElement('label', { className: "text-[10px] font-black text-slate-300 uppercase px-2" }, "æˆ¿é–“åç¨± (å…±äº«ä»£ç¢¼)"),
                                React.createElement('input', { 
                                    value: roomId, 
                                    onChange: (e) => setRoomId(e.target.value),
                                    className: "w-full p-4 bg-slate-50 rounded-2xl font-black outline-none border-2 border-transparent focus:border-rose-100"
                                })
                            )
                        ),
                        React.createElement('div', { className: "bg-slate-900 p-8 rounded-[2.5rem] text-white shadow-2xl" },
                            React.createElement('h3', { className: "font-black text-sm mb-4" }, "è‡ªå®šç¾©åŠŸèƒ½"),
                            React.createElement('p', { className: "text-xs text-slate-400 mb-6 leading-relaxed" }, "æ‚¨å¯ä»¥é»žæ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢žåˆ†é¡žæˆ–æ˜¯æ¯æœˆ 1 è™Ÿè‡ªå‹•æ‰£æ¬¾çš„å›ºå®šæ”¯å‡ºã€‚"),
                            React.createElement('div', { className: "grid grid-cols-2 gap-3" },
                                React.createElement('button', { onClick: () => alert("å³å°‡é–‹æ”¾è‡ªå®šç¾©åˆ†é¡žç·¨è¼¯"), className: "bg-white/10 p-4 rounded-2xl text-xs font-black hover:bg-white/20" }, "æ–°å¢žåˆ†é¡ž"),
                                React.createElement('button', { onClick: () => alert("å³å°‡é–‹æ”¾å›ºå®šæ”¶æ”¯è¨­å®š"), className: "bg-white/10 p-4 rounded-2xl text-xs font-black hover:bg-white/20" }, "å›ºå®šæ”¶æ”¯")
                            )
                        )
                    )
                ),

                // Bottom Tab Nav - Optimized
                React.createElement('nav', { className: "fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-xl p-2 rounded-full flex gap-1 shadow-2xl z-50 border border-slate-800" },
                    [
                        { id: 'calendar', icon: 'calendar', label: 'è¨˜å¸³' },
                        { id: 'stats', icon: 'pie-chart', label: 'åˆ†æž' },
                        { id: 'settings', icon: 'user', label: 'è¨­å®š' }
                    ].map(tab => {
                        const isActive = activeTab === tab.id;
                        return React.createElement('button', {
                            key: tab.id,
                            onClick: () => setActiveTab(tab.id),
                            className: `flex items-center gap-2 px-6 py-3.5 rounded-full transition-all duration-300 ${isActive ? 'active-tab' : 'inactive-tab'}`
                        }, 
                            React.createElement('i', { 'data-lucide': tab.icon, size: 18 }),
                            isActive && React.createElement('span', { className: "text-xs font-black tracking-tight" }, tab.label)
                        );
                    })
                ),

                // Add Modal
                showAddModal && React.createElement('div', { className: "fixed inset-0 z-[100] flex items-end sm:items-center justify-center p-4 animate-in fade-in duration-200" },
                    React.createElement('div', { className: "absolute inset-0 bg-slate-900/60 backdrop-blur-sm", onClick: () => setShowAddModal(false) }),
                    React.createElement('form', { 
                        onSubmit: handleSaveTx,
                        className: "relative bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl animate-in slide-in-from-bottom-20" 
                    },
                        React.createElement('h3', { className: "font-black text-xl mb-6 text-center" }, "æ–°å¢žæ”¯å‡º"),
                        React.createElement('div', { className: "space-y-6" },
                            React.createElement('input', { 
                                name: "amount",
                                type: "number", 
                                placeholder: "0", 
                                autoFocus: true, 
                                className: "w-full text-5xl font-black text-center outline-none bg-transparent caret-rose-500" 
                            }),
                            React.createElement('div', { className: "grid grid-cols-5 gap-3" },
                                roomData.categories.map(c => React.createElement('button', { 
                                    key: c.id, 
                                    type: "button",
                                    onClick: () => setSelCatInModal(c.id),
                                    className: `aspect-square rounded-2xl text-xl flex items-center justify-center transition-all ${selCatInModal === c.id ? 'category-selected' : 'bg-slate-50'}`
                                }, c.icon))
                            ),
                            React.createElement('input', { 
                                name: "note",
                                placeholder: "å‚™è¨»å…§å®¹ (ä¾‹å¦‚: æ™šé¤)...", 
                                className: "w-full p-4 bg-slate-50 rounded-2xl font-black outline-none text-sm border-2 border-transparent focus:border-rose-100" 
                            }),
                            React.createElement('button', { 
                                type: "submit",
                                className: "w-full py-5 bg-slate-900 text-white rounded-[2rem] font-black shadow-xl active:scale-95 transition-transform" 
                            }, "å„²å­˜æ­¤ç­†æ”¯å‡º")
                        )
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        
        // Lucide Icon Initializer
        setInterval(() => lucide.createIcons(), 500);
    </script>
</body>
</html>

