<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘å€‘çš„é›²ç«¯è¨˜å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* å°è¦½åˆ—åç™½å„ªåŒ– */
        .tab-active { 
            background-color: #0f172a !important; 
            color: #ffffff !important; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .tab-inactive { color: #64748b !important; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const DB_KEY = "LEDGER_ULTIMATE_V1"; 

        const CATEGORIES = [
            { id: 'c1', name: 'é¤é£²', icon: 'ğŸ²', color: 'bg-orange-400' },
            { id: 'c2', name: 'äº¤é€š', icon: 'ğŸš—', color: 'bg-blue-400' },
            { id: 'c3', name: 'å±…å®¶', icon: 'ğŸ ', color: 'bg-emerald-400' },
            { id: 'c4', name: 'å¨›æ¨‚', icon: 'ğŸ®', color: 'bg-purple-400' },
            { id: 'c5', name: 'è³¼ç‰©', icon: 'ğŸ›ï¸', color: 'bg-rose-400' }
        ];

        function App() {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('calendar');
            const [roomId, setRoomId] = useState(new URLSearchParams(window.location.search).get('room') || 'æˆ‘å€‘çš„å®¶');
            const [nickname, setNickname] = useState(localStorage.getItem('my_nick') || 'ä½¿ç”¨è€…');
            const [roomData, setRoomData] = useState({ transactions: [] });
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [showAdd, setShowAdd] = useState(false);
            const [selCat, setSelCat] = useState('c1');

            useEffect(() => {
                signInAnonymously(auth);
                return onAuthStateChanged(auth, setUser);
            }, []);

            useEffect(() => {
                if (!user || !roomId) return;
                const url = new URL(window.location);
                url.searchParams.set('room', roomId);
                window.history.replaceState({}, '', url);

                const roomRef = doc(db, 'artifacts', DB_KEY, 'public', 'data', 'rooms', roomId);
                return onSnapshot(roomRef, (snap) => {
                    if (snap.exists()) setRoomData(snap.data());
                    else setDoc(roomRef, { transactions: [] });
                });
            }, [user, roomId]);

            const formatDate = (date) => {
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            const calendarDays = useMemo(() => {
                const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
                const first = new Date(y, m, 1).getDay();
                const total = new Date(y, m + 1, 0).getDate();
                const days = [];
                for (let i = 0; i < first; i++) days.push(null);
                for (let i = 1; i <= total; i++) days.push(new Date(y, m, i));
                return days;
            }, [currentMonth]);

            const dayTxs = (roomData.transactions || []).filter(t => t.dateKey === formatDate(selectedDate));

            const handleSave = async (e) => {
                e.preventDefault();
                const amt = e.target.amount.value;
                if (!amt) return;
                const newTx = {
                    id: Date.now().toString(),
                    user: nickname,
                    amount: parseFloat(amt),
                    categoryId: selCat,
                    note: e.target.note.value || CATEGORIES.find(c => c.id === selCat).name,
                    dateKey: formatDate(selectedDate)
                };
                const roomRef = doc(db, 'artifacts', DB_KEY, 'public', 'data', 'rooms', roomId);
                await updateDoc(roomRef, { transactions: [newTx, ...(roomData.transactions || [])] });
                setShowAdd(false);
            };

            return React.createElement('div', { className: "max-w-md mx-auto min-h-screen pb-28" },
                // Header
                React.createElement('header', { className: "bg-white p-6 pt-10 rounded-b-[2rem] shadow-sm sticky top-0 z-40 flex justify-between items-center" },
                    React.createElement('div', null,
                        React.createElement('h1', { className: "text-lg font-black" }, roomId),
                        React.createElement('p', { className: "text-[10px] text-emerald-500 font-bold" }, "â— é›²ç«¯é€£ç·šåŒæ­¥ä¸­")
                    ),
                    React.createElement('button', { 
                        onClick: () => { navigator.clipboard.writeText(window.location.href); alert("é€£çµå·²è¤‡è£½ï¼"); },
                        className: "p-3 bg-slate-100 rounded-xl" 
                    }, React.createElement('i', { 'data-lucide': 'share-2', size: 18 }))
                ),

                // Content
                React.createElement('main', { className: "p-4 fade-in" },
                    activeTab === 'calendar' && React.createElement('div', null,
                        React.createElement('div', { className: "bg-white p-5 rounded-[2rem] shadow-sm mb-6" },
                            React.createElement('div', { className: "flex justify-between items-center mb-6" },
                                React.createElement('button', { onClick: () => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()-1))) }, React.createElement('i', { 'data-lucide': 'chevron-left' })),
                                React.createElement('span', { className: "font-black text-sm" }, `${currentMonth.getFullYear()}å¹´ ${currentMonth.getMonth()+1}æœˆ`),
                                React.createElement('button', { onClick: () => setCurrentMonth(new Date(currentMonth.setMonth(currentMonth.getMonth()+1))) }, React.createElement('i', { 'data-lucide': 'chevron-right' }))
                            ),
                            React.createElement('div', { className: "calendar-grid mb-2" }, ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => React.createElement('div', { key: d, className: "text-center text-[10px] font-black text-slate-300" }, d))),
                            React.createElement('div', { className: "calendar-grid" },
                                calendarDays.map((date, i) => {
                                    if (!date) return React.createElement('div', { key: i });
                                    const isSel = formatDate(date) === formatDate(selectedDate);
                                    const hasData = (roomData.transactions || []).some(t => t.dateKey === formatDate(date));
                                    return React.createElement('button', {
                                        key: i, onClick: () => setSelectedDate(date),
                                        className: `aspect-square rounded-xl flex items-center justify-center text-sm font-bold relative transition-all ${isSel ? 'bg-slate-900 text-white' : 'hover:bg-slate-50'}`
                                    }, date.getDate(), hasData && !isSel && React.createElement('div', { className: "absolute bottom-1 w-1 h-1 bg-rose-400 rounded-full" }));
                                })
                            )
                        ),
                        React.createElement('div', { className: "flex justify-between items-center mb-4" },
                            React.createElement('span', { className: "text-[10px] font-bold text-slate-400" }, formatDate(selectedDate)),
                            React.createElement('button', { onClick: () => setShowAdd(true), className: "bg-rose-500 text-white p-4 rounded-2xl shadow-lg active:scale-95 transition-transform" }, React.createElement('i', { 'data-lucide': 'plus' }))
                        ),
                        dayTxs.length === 0 ? React.createElement('div', { className: "py-20 text-center text-slate-300 text-xs font-bold" }, "ä»Šå¤©é‚„æ²’ç´€éŒ„å–” â˜•") :
                        dayTxs.map(t => {
                            const cat = CATEGORIES.find(c => c.id === t.categoryId);
                            return React.createElement('div', { key: t.id, className: "bg-white p-4 rounded-2xl flex justify-between items-center mb-3 shadow-sm" },
                                React.createElement('div', { className: "flex items-center gap-3" },
                                    React.createElement('div', { className: `w-10 h-10 ${cat.color} bg-opacity-10 text-xl rounded-xl flex items-center justify-center` }, cat.icon),
                                    React.createElement('div', null, React.createElement('p', { className: "font-black text-sm" }, t.note), React.createElement('p', { className: "text-[9px] text-slate-400" }, `ç”± ${t.user} è¨˜éŒ„`))
                                ),
                                React.createElement('p', { className: "font-black text-lg" }, `$${t.amount.toLocaleString()}`)
                            );
                        })
                    ),

                    activeTab === 'stats' && React.createElement('div', { className: "bg-white p-8 rounded-[2rem] shadow-sm text-center" },
                        React.createElement('p', { className: "text-xs font-bold text-slate-400 mb-2" }, "æœ¬æœˆæ¶ˆè²»æ¯”ä¾‹"),
                        React.createElement('div', { className: "space-y-4 text-left mt-6" },
                            CATEGORIES.map(cat => {
                                const total = (roomData.transactions || []).filter(t => t.categoryId === cat.id && t.dateKey.startsWith(`${currentMonth.getFullYear()}-${String(currentMonth.getMonth()+1).padStart(2,'0')}`)).reduce((s,t)=>s+t.amount,0);
                                if (total === 0) return null;
                                return React.createElement('div', { key: cat.id },
                                    React.createElement('div', { className: "flex justify-between text-xs font-bold mb-1" }, React.createElement('span', null, `${cat.icon} ${cat.name}`), React.createElement('span', null, `$${total}`)),
                                    React.createElement('div', { className: "h-2 bg-slate-50 rounded-full" }, React.createElement('div', { className: `${cat.color} h-full rounded-full`, style: { width: '50%' } }))
                                );
                            })
                        )
                    ),

                    activeTab === 'settings' && React.createElement('div', { className: "space-y-4" },
                        React.createElement('div', { className: "bg-white p-6 rounded-[2rem] shadow-sm" },
                            React.createElement('label', { className: "text-[10px] font-bold text-slate-400 ml-2" }, "æˆ‘çš„æš±ç¨±"),
                            React.createElement('input', { 
                                value: nickname, 
                                onChange: e => { setNickname(e.target.value); localStorage.setItem('my_nick', e.target.value); },
                                className: "w-full p-4 bg-slate-50 rounded-xl mt-1 outline-none font-bold"
                            })
                        )
                    )
                ),

                // Bottom Nav - åç™½åŠ å¼·ç‰ˆ
                React.createElement('nav', { className: "fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/80 backdrop-blur-md p-1.5 rounded-full flex gap-1 shadow-2xl z-50 border border-slate-100" },
                    [
                        { id: 'calendar', icon: 'calendar', label: 'è¨˜å¸³' },
                        { id: 'stats', icon: 'pie-chart', label: 'åˆ†æ' },
                        { id: 'settings', icon: 'settings', label: 'è¨­å®š' }
                    ].map(t => React.createElement('button', {
                        key: t.id, onClick: () => setActiveTab(t.id),
                        className: `flex items-center gap-2 px-6 py-3.5 rounded-full transition-all duration-300 ${activeTab === t.id ? 'tab-active' : 'tab-inactive hover:bg-slate-50'}`
                    }, 
                        React.createElement('i', { 'data-lucide': t.icon, size: 18 }), 
                        activeTab === t.id && React.createElement('span', { className: "text-xs font-black tracking-tight" }, t.label)
                    ))
                ),

                // Add Modal
                showAdd && React.createElement('div', { className: "fixed inset-0 z-[100] flex items-end justify-center p-4" },
                    React.createElement('div', { className: "absolute inset-0 bg-slate-900/60 backdrop-blur-sm", onClick: () => setShowAdd(false) }),
                    React.createElement('form', { onSubmit: handleSave, className: "relative bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl fade-in" },
                        React.createElement('h3', { className: "font-black text-center mb-6" }, "æ–°å¢æ”¯å‡º"),
                        React.createElement('input', { name: "amount", type: "number", placeholder: "0", autoFocus: true, className: "w-full text-5xl font-black text-center mb-8 outline-none" }),
                        React.createElement('div', { className: "grid grid-cols-5 gap-3 mb-8" },
                            CATEGORIES.map(c => React.createElement('button', { 
                                key: c.id, type: "button", onClick: () => setSelCat(c.id), 
                                className: `aspect-square rounded-2xl flex items-center justify-center text-xl transition-all ${selCat === c.id ? 'bg-slate-900 text-white scale-110 shadow-lg' : 'bg-slate-50'}` 
                            }, c.icon))
                        ),
                        React.createElement('input', { name: "note", placeholder: "å‚™è¨»å…§å®¹...", className: "w-full p-4 bg-slate-50 rounded-2xl font-bold mb-6 outline-none" }),
                        React.createElement('button', { type: "submit", className: "w-full py-5 bg-slate-900 text-white rounded-3xl font-black shadow-lg" }, "å„²å­˜ç´€éŒ„")
                    )
                )
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
        setInterval(() => lucide.createIcons(), 500);
    </script>
</body>
</html>

