import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, onSnapshot, setDoc, collection } from 'firebase/firestore';
import { 
  Calendar, 
  ChevronLeft, 
  ChevronRight, 
  Plus, 
  PieChart, 
  Settings, 
  List, 
  User, 
  Check, 
  X,
  Trash2,
  Edit2
} from 'lucide-react';
import { Pie } from 'react-chartjs-2';
import { Chart as ChartJS, ArcElement, Tooltip, Legend } from 'chart.js';

ChartJS.register(ArcElement, Tooltip, Legend);

// Firebase å…¨åŸŸè®Šæ•¸è™•ç†
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'shared-ledger';

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('calendar'); // calendar, chart, settings
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [currentUserIdentity, setCurrentUserIdentity] = useState('A'); // 'A' or 'B'
  const [roomID, setRoomID] = useState('');
  
  // æ ¸å¿ƒæ•¸æ“šç‹€æ…‹
  const [ledgerData, setLedgerData] = useState({
    transactions: [],
    categories: [
      { id: '1', name: 'é¤é£²', icon: 'ğŸ±', color: '#fb7185' },
      { id: '2', name: 'äº¤é€š', icon: 'ğŸš—', color: '#60a5fa' },
      { id: '3', name: 'è³¼ç‰©', icon: 'ğŸ›’', color: '#fbbf24' },
      { id: '4', name: 'å¨›æ¨‚', icon: 'ğŸ®', color: '#a78bfa' },
      { id: '5', name: 'å±…å®¶', icon: 'ğŸ ', color: '#4ade80' }
    ],
    budgets: { income: 50000, expense: 30000 }
  });

  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isSyncing, setIsSyncing] = useState(true);

  // 1. åˆå§‹åŒ–èˆ‡èº«ä»½èªè­‰ (Rule 3)
  useEffect(() => {
    const initAuth = async () => {
      await signInAnonymously(auth);
    };
    initAuth();
    const unsub = onAuthStateChanged(auth, setUser);

    // ç²å–ç¶²å€ Room ID
    const params = new URLSearchParams(window.location.search);
    const r = params.get('room') || 'default-room';
    setRoomID(r);

    return () => unsub();
  }, []);

  // 2. æ•¸æ“šåŒæ­¥ (Rule 1 & 2)
  useEffect(() => {
    if (!user || !roomID) return;

    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomID);
    const unsub = onSnapshot(docRef, (docSnap) => {
      if (docSnap.exists()) {
        setLedgerData(docSnap.data());
      } else {
        // åˆå§‹åŒ–æ–°ç¾¤çµ„
        saveData(ledgerData);
      }
      setIsSyncing(false);
    }, (err) => {
      console.error("Firestore Error:", err);
      setIsSyncing(false);
    });

    return () => unsub();
  }, [user, roomID]);

  const saveData = async (newData) => {
    if (!user) return;
    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', roomID);
    await setDoc(docRef, newData);
  };

  // 3. é‚è¼¯è¨ˆç®—
  const calendarDays = useMemo(() => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    const days = [];
    for (let i = 0; i < firstDay; i++) days.push(null);
    for (let d = 1; d <= daysInMonth; d++) days.push(new Date(year, month, d));
    return days;
  }, [currentDate]);

  const selectedDayTransactions = useMemo(() => {
    return ledgerData.transactions.filter(t => 
      t.date === selectedDate.toDateString()
    );
  }, [ledgerData.transactions, selectedDate]);

  const hasRecord = (date) => {
    if (!date) return false;
    return ledgerData.transactions.some(t => t.date === date.toDateString());
  };

  // 4. æ¸²æŸ“çµ„ä»¶
  const AddTransactionModal = () => {
    const [amount, setAmount] = useState('');
    const [note, setNote] = useState('');
    const [catId, setCatId] = useState(ledgerData.categories[0].id);
    const [type, setType] = useState('expense');

    const handleSave = () => {
      if (!amount) return;
      const newTx = {
        id: Date.now().toString(),
        amount: type === 'expense' ? -Math.abs(amount) : Math.abs(amount),
        note: note || ledgerData.categories.find(c => c.id === catId).name,
        catId,
        date: selectedDate.toDateString(),
        createdBy: currentUserIdentity, // A or B
        timestamp: Date.now()
      };
      const newData = {
        ...ledgerData,
        transactions: [newTx, ...ledgerData.transactions]
      };
      saveData(newData);
      setIsModalOpen(false);
    };

    return (
      <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4">
        <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setIsModalOpen(false)} />
        <div className="relative bg-white w-full max-w-md rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom duration-300">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-xl font-black text-slate-800">ç”¨æˆ¶ {currentUserIdentity} è¨˜å¸³ä¸­</h3>
            <button onClick={() => setIsModalOpen(false)} className="p-2 bg-slate-100 rounded-full text-slate-400"><X size={20}/></button>
          </div>

          <div className="flex bg-slate-100 p-1 rounded-2xl mb-6">
            <button 
              onClick={() => setType('expense')}
              className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${type === 'expense' ? 'bg-white text-rose-500 shadow-sm' : 'text-slate-400'}`}
            >æ”¯å‡º</button>
            <button 
              onClick={() => setType('income')}
              className={`flex-1 py-3 rounded-xl font-bold text-sm transition-all ${type === 'income' ? 'bg-white text-emerald-500 shadow-sm' : 'text-slate-400'}`}
            >æ”¶å…¥</button>
          </div>

          <div className="mb-6">
            <input 
              type="number" 
              placeholder="0"
              value={amount}
              onChange={e => setAmount(e.target.value)}
              className="w-full text-5xl font-black text-center outline-none bg-transparent text-slate-800"
              autoFocus
            />
          </div>

          <div className="grid grid-cols-5 gap-3 mb-6">
            {ledgerData.categories.map(cat => (
              <button 
                key={cat.id}
                onClick={() => setCatId(cat.id)}
                className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all ${catId === cat.id ? 'bg-slate-900 text-white scale-110' : 'bg-slate-50'}`}
              >
                <span className="text-xl">{cat.icon}</span>
                <span className="text-[10px] font-bold">{cat.name}</span>
              </button>
            ))}
          </div>

          <input 
            placeholder="å‚™è¨»..." 
            value={note}
            onChange={e => setNote(e.target.value)}
            className="w-full p-4 bg-slate-50 rounded-2xl mb-6 font-bold text-sm outline-none border-2 border-transparent focus:border-slate-200"
          />

          <button 
            onClick={handleSave}
            className="w-full bg-slate-900 text-white py-5 rounded-3xl font-black text-lg shadow-xl active:scale-95 transition-all"
          >
            å®Œæˆè¨˜å¸³
          </button>
        </div>
      </div>
    );
  };

  const ChartView = () => {
    const expenseData = ledgerData.categories.map(cat => {
      const sum = ledgerData.transactions
        .filter(t => t.catId === cat.id && t.amount < 0)
        .reduce((acc, curr) => acc + Math.abs(curr.amount), 0);
      return sum;
    });

    const data = {
      labels: ledgerData.categories.map(c => c.name),
      datasets: [{
        data: expenseData,
        backgroundColor: ledgerData.categories.map(c => c.color),
        borderWidth: 0
      }]
    };

    return (
      <div className="p-6 space-y-6 animate-in fade-in duration-500">
        <div className="bg-white p-6 rounded-[2rem] shadow-sm">
          <h3 className="text-lg font-black text-slate-800 mb-6">æ”¯å‡ºçµæ§‹åˆ†æ</h3>
          <div className="aspect-square flex items-center justify-center">
            {expenseData.every(v => v === 0) ? (
              <p className="text-slate-300 font-bold">ç›®å‰å°šç„¡æ•¸æ“š</p>
            ) : (
              <Pie data={data} options={{ plugins: { legend: { position: 'bottom', labels: { font: { weight: 'bold' } } } } }} />
            )}
          </div>
        </div>

        <div className="grid grid-cols-2 gap-4">
          <div className="bg-white p-6 rounded-[2rem] shadow-sm">
            <p className="text-[10px] font-black text-slate-400 uppercase">ç¸½æ”¶å…¥é ç®—</p>
            <p className="text-xl font-black text-emerald-500">${ledgerData.budgets.income.toLocaleString()}</p>
          </div>
          <div className="bg-white p-6 rounded-[2rem] shadow-sm">
            <p className="text-[10px] font-black text-slate-400 uppercase">ç¸½æ”¯å‡ºé ç®—</p>
            <p className="text-xl font-black text-rose-500">${ledgerData.budgets.expense.toLocaleString()}</p>
          </div>
        </div>
      </div>
    );
  };

  const SettingsView = () => {
    const [newCatName, setNewCatName] = useState('');
    
    const addCat = () => {
      if (!newCatName) return;
      const newCat = {
        id: Date.now().toString(),
        name: newCatName,
        icon: 'ğŸ“Œ',
        color: '#' + Math.floor(Math.random()*16777215).toString(16)
      };
      saveData({ ...ledgerData, categories: [...ledgerData.categories, newCat] });
      setNewCatName('');
    };

    const deleteCat = (id) => {
      saveData({ ...ledgerData, categories: ledgerData.categories.filter(c => c.id !== id) });
    };

    const updateBudget = (type, val) => {
      saveData({
        ...ledgerData,
        budgets: { ...ledgerData.budgets, [type]: Number(val) }
      });
    };

    const copyRoomLink = () => {
      const url = `${window.location.origin}${window.location.pathname}?room=${roomID}`;
      document.execCommand('copy'); // Fallback for copy
      const el = document.createElement('textarea');
      el.value = url;
      document.body.appendChild(el);
      el.select();
      document.execCommand('copy');
      document.body.removeChild(el);
      // å¯æ“´å……æç¤ºå·²è¤‡è£½
    };

    return (
      <div className="p-6 space-y-6 animate-in slide-in-from-bottom-4 duration-500">
        <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
          <h3 className="font-black text-slate-800 text-xl mb-4">é ç®—è¨­å®š</h3>
          <div className="space-y-4">
            <div>
              <label className="text-[11px] font-black text-slate-400 ml-1">æ¯æœˆé æœŸæ”¶å…¥</label>
              <input 
                type="number"
                value={ledgerData.budgets.income}
                onChange={e => updateBudget('income', e.target.value)}
                className="w-full p-4 bg-slate-50 rounded-2xl font-bold mt-1 outline-none focus:ring-2 ring-emerald-100"
              />
            </div>
            <div>
              <label className="text-[11px] font-black text-slate-400 ml-1">æ¯æœˆé æœŸæ”¯å‡º</label>
              <input 
                type="number"
                value={ledgerData.budgets.expense}
                onChange={e => updateBudget('expense', e.target.value)}
                className="w-full p-4 bg-slate-50 rounded-2xl font-bold mt-1 outline-none focus:ring-2 ring-rose-100"
              />
            </div>
          </div>
        </div>

        <div className="bg-white p-8 rounded-[2.5rem] shadow-sm border border-slate-100">
          <h3 className="font-black text-slate-800 text-xl mb-4">åˆ†é¡ç®¡ç†</h3>
          <div className="flex gap-2 mb-4">
            <input 
              placeholder="æ–°åˆ†é¡åç¨±..."
              value={newCatName}
              onChange={e => setNewCatName(e.target.value)}
              className="flex-1 p-4 bg-slate-50 rounded-2xl font-bold outline-none"
            />
            <button onClick={addCat} className="bg-slate-900 text-white px-6 rounded-2xl font-black"><Plus/></button>
          </div>
          <div className="space-y-2">
            {ledgerData.categories.map(cat => (
              <div key={cat.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl">
                <span className="font-bold">{cat.icon} {cat.name}</span>
                <button onClick={() => deleteCat(cat.id)} className="text-slate-300 hover:text-rose-500"><Trash2 size={16}/></button>
              </div>
            ))}
          </div>
        </div>

        <div className="bg-slate-900 p-8 rounded-[2.5rem] text-white">
          <h3 className="font-black text-xl mb-2">åŒæ­¥é€™æœ¬å¸³</h3>
          <p className="text-slate-400 text-xs mb-4">å°‡æ­¤é€£çµåˆ†äº«çµ¦å¦ä¸€åŠï¼Œå³å¯é–‹å§‹å…±åŒè¨˜å¸³ã€‚</p>
          <button 
            onClick={copyRoomLink}
            className="w-full bg-white/10 hover:bg-white/20 py-4 rounded-2xl font-bold text-sm transition-all flex items-center justify-center gap-2"
          >
            <List size={18}/> è¤‡è£½é‚€è«‹é€£çµ
          </button>
        </div>
      </div>
    );
  };

  // --- ä¸»é é¢æ¸²æŸ“ ---
  return (
    <div className="max-w-md mx-auto min-h-screen bg-slate-50 flex flex-col font-sans pb-32">
      {/* é ‚éƒ¨å°è¦½: ç”¨æˆ¶åˆ‡æ› */}
      <header className="p-6 bg-white rounded-b-[3rem] shadow-sm border-b border-slate-100 sticky top-0 z-40">
        <div className="flex justify-between items-center mb-4">
          <div className="flex items-center gap-2">
            <div className="w-2 h-2 rounded-full bg-rose-500 animate-pulse" />
            <h1 className="font-black text-slate-800 tracking-tighter">SHARE LEDGER</h1>
          </div>
          <div className="bg-slate-100 p-1 rounded-full flex gap-1">
            <button 
              onClick={() => setCurrentUserIdentity('A')}
              className={`px-5 py-1.5 rounded-full text-xs font-black transition-all ${currentUserIdentity === 'A' ? 'bg-slate-900 text-white shadow-lg' : 'text-slate-400'}`}
            >ç”¨æˆ¶ A</button>
            <button 
              onClick={() => setCurrentUserIdentity('B')}
              className={`px-5 py-1.5 rounded-full text-xs font-black transition-all ${currentUserIdentity === 'B' ? 'bg-slate-900 text-white shadow-lg' : 'text-slate-400'}`}
            >ç”¨æˆ¶ B</button>
          </div>
        </div>
        
        {activeTab === 'calendar' && (
          <div className="flex justify-between items-center">
            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1))} className="p-2 text-slate-400"><ChevronLeft/></button>
            <h2 className="font-black text-lg text-slate-800">{currentDate.getFullYear()}å¹´ {currentDate.getMonth() + 1}æœˆ</h2>
            <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1))} className="p-2 text-slate-400"><ChevronRight/></button>
          </div>
        )}
      </header>

      {/* å…§å®¹å€ */}
      <main className="flex-1 overflow-y-auto no-scrollbar">
        {activeTab === 'calendar' ? (
          <div className="p-4 space-y-4">
            {/* æ—¥æ›† */}
            <div className="bg-white rounded-[2.5rem] p-6 shadow-sm border border-slate-50">
              <div className="grid grid-cols-7 mb-2 text-center text-[10px] font-black text-slate-300 uppercase tracking-widest">
                {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => <div key={d}>{d}</div>)}
              </div>
              <div className="grid grid-cols-7 gap-y-2">
                {calendarDays.map((date, i) => (
                  <button 
                    key={i}
                    onClick={() => date && setSelectedDate(date)}
                    className={`aspect-square flex flex-col items-center justify-center relative rounded-2xl transition-all ${!date ? 'opacity-0' : ''} ${selectedDate?.toDateString() === date?.toDateString() ? 'bg-slate-900 text-white shadow-xl scale-110' : 'hover:bg-slate-50'}`}
                  >
                    <span className="text-sm font-black">{date?.getDate()}</span>
                    {hasRecord(date) && (
                      <div className={`w-1 h-1 rounded-full mt-0.5 ${selectedDate?.toDateString() === date?.toDateString() ? 'bg-white' : 'bg-rose-500'}`} />
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* ç•¶æ—¥åˆ—è¡¨ */}
            <div className="space-y-3">
              <h3 className="text-xs font-black text-slate-400 ml-4 uppercase tracking-widest">ä»Šæ—¥æ˜ç´°</h3>
              {selectedDayTransactions.length === 0 ? (
                <div className="text-center py-12 text-slate-300 font-bold">ä»Šå¤©é‚„æ²’æœ‰è¨˜å¸³å–”</div>
              ) : (
                selectedDayTransactions.map(tx => (
                  <div key={tx.id} className="bg-white p-4 rounded-3xl flex justify-between items-center shadow-sm border border-slate-100 animate-in slide-in-from-top-2">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center text-2xl">
                        {ledgerData.categories.find(c => c.id === tx.catId)?.icon || 'ğŸ’°'}
                      </div>
                      <div>
                        <p className="font-black text-slate-800 text-sm">{tx.note}</p>
                        <div className="flex gap-2 items-center">
                          <span className={`text-[10px] font-black px-2 py-0.5 rounded-full ${tx.createdBy === 'A' ? 'bg-blue-100 text-blue-500' : 'bg-purple-100 text-purple-500'}`}>
                            USER {tx.createdBy}
                          </span>
                        </div>
                      </div>
                    </div>
                    <div className="text-right">
                      <p className={`font-black text-lg ${tx.amount > 0 ? 'text-emerald-500' : 'text-slate-800'}`}>
                        {tx.amount > 0 ? '+' : ''}{tx.amount.toLocaleString()}
                      </p>
                      <button 
                        onClick={() => saveData({ ...ledgerData, transactions: ledgerData.transactions.filter(t => t.id !== tx.id) })}
                        className="text-slate-200 hover:text-rose-500 transition-colors"
                      >
                        <Trash2 size={12}/>
                      </button>
                    </div>
                  </div>
                ))
              )}
            </div>
          </div>
        ) : activeTab === 'chart' ? (
          <ChartView />
        ) : (
          <SettingsView />
        )}
      </main>

      {/* åº•éƒ¨å°è¦½ */}
      <footer className="fixed bottom-8 left-0 right-0 px-6 z-50">
        <div className="max-w-sm mx-auto bg-slate-900/90 backdrop-blur-md rounded-full p-2 flex items-center justify-between border border-white/10 shadow-2xl">
          <button 
            onClick={() => setActiveTab('calendar')}
            className={`p-4 rounded-full transition-all ${activeTab === 'calendar' ? 'bg-white text-slate-900 shadow-xl' : 'text-slate-400 hover:text-white'}`}
          >
            <Calendar size={20}/>
          </button>
          
          <button 
            onClick={() => setIsModalOpen(true)}
            className="bg-rose-500 text-white p-5 rounded-full shadow-lg hover:scale-105 active:scale-95 transition-all mx-2"
          >
            <Plus size={24} strokeWidth={3}/>
          </button>

          <div className="flex gap-1">
            <button 
              onClick={() => setActiveTab('chart')}
              className={`p-4 rounded-full transition-all ${activeTab === 'chart' ? 'bg-white text-slate-900 shadow-xl' : 'text-slate-400 hover:text-white'}`}
            >
              <PieChart size={20}/>
            </button>
            <button 
              onClick={() => setActiveTab('settings')}
              className={`p-4 rounded-full transition-all ${activeTab === 'settings' ? 'bg-white text-slate-900 shadow-xl' : 'text-slate-400 hover:text-white'}`}
            >
              <Settings size={20}/>
            </button>
          </div>
        </div>
      </footer>

      {isModalOpen && <AddTransactionModal />}

      {/* åŠ è¼‰ç‹€æ…‹ */}
      {isSyncing && (
        <div className="fixed inset-0 bg-white z-[60] flex items-center justify-center">
          <div className="text-center space-y-4">
            <div className="w-12 h-12 border-4 border-slate-100 border-t-rose-500 rounded-full animate-spin mx-auto" />
            <p className="font-black text-slate-400 text-xs tracking-widest uppercase">Syncing Ledger...</p>
          </div>
        </div>
      )}
    </div>
  );
}
