<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ä¾¶é›²ç«¯è¨˜å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- åœ–è¡¨åº« -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; margin: 0; padding: 0; overflow-x: hidden; }
        .active-tab { background-color: #0f172a !important; color: white !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        input { outline: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Firebase åˆå§‹åŒ–
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const hasFirebase = !!firebaseConfig.apiKey;
        if (hasFirebase && !firebase.apps.length) firebase.initializeApp(firebaseConfig);
        
        const DEFAULT_CATS = [
            { id: 'c1', name: 'é¤é£²', icon: 'ğŸ²', color: '#fb7185' },
            { id: 'c2', name: 'äº¤é€š', icon: 'ğŸš—', color: '#60a5fa' },
            { id: 'c3', name: 'å±…å®¶', icon: 'ğŸ ', color: '#34d399' },
            { id: 'c4', name: 'è³¼ç‰©', icon: 'ğŸ›ï¸', color: '#fbbf24' }
        ];

        function App() {
            const [activeTab, setActiveTab] = useState('book');
            const [roomName, setRoomName] = useState(localStorage.getItem('room') || 'å®¶');
            const [userName, setUserName] = useState(localStorage.getItem('user') || 'ç”¨æˆ¶A');
            const [viewUser, setViewUser] = useState('all');
            
            const [dbData, setDbData] = useState(() => {
                const cached = localStorage.getItem(`cache_${roomName}`);
                return cached ? JSON.parse(cached) : { transactions: [], categories: DEFAULT_CATS, recurring: [] };
            });
            
            const [loading, setLoading] = useState(hasFirebase);
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [showAdd, setShowAdd] = useState(false);

            // Form States
            const [amt, setAmt] = useState('');
            const [note, setNote] = useState('');
            const [selCatId, setSelCatId] = useState('c1');
            const [isIncome, setIsIncome] = useState(false);
            const [recForm, setRecForm] = useState({ name: '', amt: '', day: '1' });

            const dateStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            // Sync with Firebase
            useEffect(() => {
                if (!hasFirebase) { setLoading(false); return; }
                let unsub;
                const init = async () => {
                    try {
                        await firebase.auth().signInAnonymously();
                        const db = firebase.firestore();
                        const appId = window.__app_id || 'v1-ledger';
                        const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName);
                        
                        unsub = docRef.onSnapshot(doc => {
                            if (doc.exists) {
                                const d = doc.data();
                                const updated = {
                                    transactions: d.transactions || [],
                                    categories: d.categories || DEFAULT_CATS,
                                    recurring: d.recurring || []
                                };
                                setDbData(updated);
                                localStorage.setItem(`cache_${roomName}`, JSON.stringify(updated));
                            } else {
                                docRef.set({ transactions: [], categories: DEFAULT_CATS, recurring: [] });
                            }
                            setLoading(false);
                        }, () => setLoading(false));
                    } catch (e) { setLoading(false); }
                };
                init();
                return () => unsub && unsub();
            }, [roomName]);

            const updateDB = async (payload) => {
                const newData = { ...dbData, ...payload };
                setDbData(newData);
                localStorage.setItem(`cache_${roomName}`, JSON.stringify(newData));
                if (hasFirebase) {
                    const db = firebase.firestore();
                    const appId = window.__app_id || 'v1-ledger';
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName).update(payload);
                }
            };

            // Helpers
            const users = useMemo(() => {
                const s = new Set(dbData.transactions.map(t => t.user));
                s.add(userName);
                return Array.from(s);
            }, [dbData.transactions, userName]);

            const monthLogs = useMemo(() => {
                const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
                return dbData.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear() === y && d.getMonth() === m;
                });
            }, [dbData.transactions, currentMonth]);

            const currentDayLogs = useMemo(() => {
                const normal = dbData.transactions.filter(t => t.date === dateStr(selectedDate));
                const recs = (dbData.recurring || []).filter(r => parseInt(r.day) === selectedDate.getDate());
                const combined = [...normal, ...recs.map(r => ({ ...r, isRec: true }))];
                return viewUser === 'all' ? combined : combined.filter(t => t.user === viewUser);
            }, [dbData, selectedDate, viewUser]);

            // Chart Logic
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                if (activeTab === 'chart' && chartRef.current) {
                    if (chartInstance.current) chartInstance.current.destroy();
                    
                    const filtered = viewUser === 'all' ? monthLogs : monthLogs.filter(t => t.user === viewUser);
                    const expenses = filtered.filter(t => t.amount < 0);
                    const catMap = {};
                    expenses.forEach(e => {
                        const cat = dbData.categories.find(c => c.id === e.catId)?.name || 'å…¶ä»–';
                        catMap[cat] = (catMap[cat] || 0) + Math.abs(e.amount);
                    });

                    chartInstance.current = new Chart(chartRef.current, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(catMap),
                            datasets: [{
                                data: Object.values(catMap),
                                backgroundColor: ['#fb7185', '#60a5fa', '#34d399', '#fbbf24', '#a78bfa', '#f472b6'],
                                borderWidth: 0,
                                hoverOffset: 10
                            }]
                        },
                        options: { 
                            plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, font: { weight: 'bold' } } } },
                            cutout: '70%'
                        }
                    });
                }
            }, [activeTab, monthLogs, viewUser]);

            return (
                <div className="max-w-md mx-auto min-h-screen pb-32">
                    {/* Sticky Header */}
                    <header className="bg-white p-6 pt-10 rounded-b-[2.5rem] shadow-sm sticky top-0 z-40">
                        <div className="flex justify-between items-center mb-6 px-2">
                            <h1 className="font-black text-slate-800 text-xl tracking-tighter">ğŸ  {roomName}</h1>
                            <div className={`w-2 h-2 rounded-full ${loading ? 'bg-amber-400 animate-pulse' : 'bg-emerald-400'}`} />
                        </div>
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                            <button onClick={() => setViewUser('all')} className={`px-5 py-2.5 rounded-2xl text-[11px] font-black whitespace-nowrap tab-transition ${viewUser === 'all' ? 'bg-slate-900 text-white shadow-lg' : 'bg-slate-50 text-slate-400'}`}>å…¨éƒ¨æ˜ç´°</button>
                            {users.map(u => (
                                <button key={u} onClick={() => setViewUser(u)} className={`px-5 py-2.5 rounded-2xl text-[11px] font-black whitespace-nowrap tab-transition ${viewUser === u ? 'bg-rose-500 text-white shadow-lg shadow-rose-100' : 'bg-slate-50 text-slate-400'}`}>
                                    {u === userName ? 'æˆ‘' : u}
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="p-4 space-y-6">
                        {activeTab === 'book' && (
                            <>
                                {/* æ—¥æ›† */}
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-50">
                                    <div className="flex justify-between items-center mb-6 px-2 font-black text-slate-800">
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1))}>â€¹</button>
                                        <span className="tracking-widest text-sm">{currentMonth.getFullYear()} / {currentMonth.getMonth()+1}</span>
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1))}>â€º</button>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 text-[10px] text-slate-300 font-black text-center mb-2">
                                        {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d}>{d}</div>)}
                                    </div>
                                    <div className="grid grid-cols-7 gap-1">
                                        {Array.from({ length: new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1).getDay() }).map((_, i) => <div key={`empty-${i}`} />)}
                                        {Array.from({ length: new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1, 0).getDate() }).map((_, i) => {
                                            const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), i+1);
                                            const isSel = dateStr(d) === dateStr(selectedDate);
                                            const hasTx = dbData.transactions.some(t => t.date === dateStr(d)) || dbData.recurring.some(r => parseInt(r.day) === d.getDate());
                                            return (
                                                <button key={i} onClick={() => setSelectedDate(d)} className={`aspect-square rounded-2xl flex flex-col items-center justify-center text-xs font-black relative tab-transition ${isSel ? 'bg-slate-900 text-white shadow-xl scale-110 z-10' : 'text-slate-600'}`}>
                                                    {i+1}
                                                    {hasTx && !isSel && <div className="absolute bottom-1.5 w-1 h-1 bg-rose-500 rounded-full" />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* æ˜ç´°åˆ—è¡¨ */}
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-4">
                                        <h2 className="text-[10px] font-black text-slate-400 tracking-widest uppercase italic">{dateStr(selectedDate)}</h2>
                                        <button onClick={() => setShowAdd(true)} className="bg-rose-500 text-white px-6 py-3.5 rounded-2xl text-xs font-black shadow-lg shadow-rose-100 active:scale-95 transition-all">ï¼‹ è¨˜ä¸€ç­†</button>
                                    </div>
                                    {currentDayLogs.length === 0 ? (
                                        <div className="py-20 text-center text-slate-300 font-bold text-xs uppercase tracking-widest">No Data</div>
                                    ) : (
                                        currentDayLogs.map(t => (
                                            <div key={t.id} className="bg-white p-5 rounded-[2rem] flex justify-between items-center shadow-sm border border-slate-50">
                                                <div className="flex items-center gap-4">
                                                    <div className="text-2xl w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center">
                                                        {t.isRec ? 'ğŸ”„' : (dbData.categories.find(c => c.id === t.catId)?.icon || 'ğŸ’°')}
                                                    </div>
                                                    <div>
                                                        <p className="font-black text-slate-800 text-sm">{t.note || t.name}</p>
                                                        <p className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">{t.user} {t.isRec && '| å›ºå®šæ”¶æ”¯'}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className={`font-black text-lg ${t.amount > 0 ? 'text-emerald-500' : 'text-slate-900'}`}>
                                                        {t.amount > 0 ? `+$${t.amount}` : `-$${Math.abs(t.amount)}`}
                                                    </p>
                                                    {!t.isRec && (
                                                        <button onClick={() => updateDB({ transactions: dbData.transactions.filter(i => i.id !== t.id) })} className="text-[9px] text-rose-300 font-bold">åˆªé™¤</button>
                                                    )}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'chart' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm text-center">
                                    <h3 className="font-black text-slate-400 text-[10px] uppercase tracking-[0.2em] mb-4">æœˆåº¦æ”¯å‡ºæ¯”ä¾‹</h3>
                                    <div className="relative inline-block w-full max-w-[240px]">
                                        <canvas ref={chartRef}></canvas>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center -z-10">
                                            <p className="text-[10px] font-black text-slate-300 uppercase">Total</p>
                                            <p className="text-2xl font-black text-slate-800">
                                                ${Math.abs(monthLogs.filter(t => t.amount < 0 && (viewUser === 'all' || t.user === viewUser)).reduce((a, b) => a + b.amount, 0))}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-emerald-50 p-6 rounded-[2.5rem]">
                                        <p className="text-[9px] font-black text-emerald-400 uppercase mb-1">æœ¬æœˆç¸½æ”¶å…¥</p>
                                        <p className="text-xl font-black text-emerald-600">${monthLogs.filter(t => t.amount > 0 && (viewUser === 'all' || t.user === viewUser)).reduce((a, b) => a + b.amount, 0)}</p>
                                    </div>
                                    <div className="bg-rose-50 p-6 rounded-[2.5rem]">
                                        <p className="text-[9px] font-black text-rose-400 uppercase mb-1">æœ¬æœˆç¸½æ”¯å‡º</p>
                                        <p className="text-xl font-black text-rose-600">${Math.abs(monthLogs.filter(t => t.amount < 0 && (viewUser === 'all' || t.user === viewUser)).reduce((a, b) => a + b.amount, 0))}</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                                {/* å€‹äººèˆ‡åŒæ­¥ */}
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-6">
                                    <h3 className="font-black text-slate-800">å€‹äººèˆ‡åŒæ­¥è¨­å®š</h3>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 ml-2">æˆ‘çš„åå­—</label>
                                        <input value={userName} onChange={e => {setUserName(e.target.value); localStorage.setItem('user', e.target.value);}} className="w-full p-4 bg-slate-50 rounded-2xl font-bold mt-1" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 ml-2">æˆ¿é–“åç¨± (åŒæ­¥ç”¨)</label>
                                        <input value={roomName} onChange={e => {setRoomName(e.target.value); localStorage.setItem('room', e.target.value);}} className="w-full p-4 bg-slate-50 rounded-2xl font-bold mt-1 border-2 border-rose-50" />
                                    </div>
                                </div>

                                {/* å›ºå®šæ”¶æ”¯ç®¡ç† */}
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-4">
                                    <h3 className="font-black text-slate-800 underline decoration-rose-100 decoration-4">æ¯æœˆå›ºå®šé …ç›®</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input value={recForm.name} onChange={e => setRecForm({...recForm, name: e.target.value})} placeholder="é …ç›®" className="p-4 bg-slate-50 rounded-2xl font-bold text-xs" />
                                        <input type="number" value={recForm.amt} onChange={e => setRecForm({...recForm, amt: e.target.value})} placeholder="é‡‘é¡" className="p-4 bg-slate-50 rounded-2xl font-bold text-xs" />
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] font-black text-slate-400">æ¯æœˆå¹¾è™Ÿï¼Ÿ</span>
                                        <input type="number" min="1" max="31" value={recForm.day} onChange={e => setRecForm({...recForm, day: e.target.value})} className="w-16 p-4 bg-slate-50 rounded-2xl font-bold text-center" />
                                        <button onClick={() => {
                                            if(!recForm.name || !recForm.amt) return;
                                            const newItem = { id: 'r'+Date.now(), name: recForm.name, amount: -Math.abs(recForm.amt), day: recForm.day, user: userName };
                                            updateDB({ recurring: [...dbData.recurring, newItem] });
                                            setRecForm({ name: '', amt: '', day: '1' });
                                        }} className="flex-1 bg-slate-900 text-white p-4 rounded-2xl font-black text-xs">åŠ å…¥</button>
                                    </div>
                                    <div className="space-y-2 pt-2">
                                        {dbData.recurring.map(r => (
                                            <div key={r.id} className="flex justify-between items-center p-4 bg-slate-50 rounded-2xl text-[10px] font-bold">
                                                <span>{r.name} ({r.day}è™Ÿ) | ${Math.abs(r.amount)}</span>
                                                <button onClick={() => updateDB({ recurring: dbData.recurring.filter(i => i.id !== r.id) })} className="text-rose-400 font-black">ç§»é™¤</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* åˆ†é¡ç®¡ç† */}
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-4">
                                    <h3 className="font-black text-slate-800">è‡ªå®šç¾©åˆ†é¡</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        {dbData.categories.map(c => (
                                            <div key={c.id} className="flex justify-between p-3 bg-slate-50 rounded-xl text-xs font-bold items-center">
                                                <span>{c.icon} {c.name}</span>
                                                <button onClick={() => updateDB({ categories: dbData.categories.filter(i => i.id !== c.id) })} className="text-slate-300 text-lg">Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => {
                                        const n = prompt("åˆ†é¡åç¨±ï¼Ÿ");
                                        const i = prompt("Emojiï¼Ÿ");
                                        if(n && i) updateDB({ categories: [...dbData.categories, { id: 'c'+Date.now(), name: n, icon: i }] });
                                    }} className="w-full py-4 border-2 border-dashed border-slate-100 rounded-2xl text-slate-300 font-bold text-xs">ï¼‹ æ–°å¢åˆ†é¡</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Navbar */}
                    <nav className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl p-2 rounded-full flex gap-1 shadow-2xl z-50 border border-white">
                        <button onClick={() => setActiveTab('book')} className={`flex items-center gap-2 px-7 py-4 rounded-full tab-transition ${activeTab === 'book' ? 'active-tab shadow-lg' : 'text-slate-300'}`}>
                            <span className="text-lg">ğŸ“…</span>
                            {activeTab === 'book' && <span className="text-[11px] font-black">è¨˜å¸³</span>}
                        </button>
                        <button onClick={() => setActiveTab('chart')} className={`flex items-center gap-2 px-7 py-4 rounded-full tab-transition ${activeTab === 'chart' ? 'active-tab shadow-lg' : 'text-slate-300'}`}>
                            <span className="text-lg">ğŸ“Š</span>
                            {activeTab === 'chart' && <span className="text-[11px] font-black">å ±è¡¨</span>}
                        </button>
                        <button onClick={() => setActiveTab('settings')} className={`flex items-center gap-2 px-7 py-4 rounded-full tab-transition ${activeTab === 'settings' ? 'active-tab shadow-lg' : 'text-slate-300'}`}>
                            <span className="text-lg">âš™ï¸</span>
                            {activeTab === 'settings' && <span className="text-[11px] font-black">è¨­å®š</span>}
                        </button>
                    </nav>

                    {/* Add Modal */}
                    {showAdd && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={() => setShowAdd(false)} />
                            <div className="relative bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl animate-in slide-in-from-bottom-full duration-300">
                                <div className="flex justify-center mb-6">
                                    <div className="bg-slate-100 p-1.5 rounded-2xl flex">
                                        <button onClick={() => setIsIncome(false)} className={`px-8 py-2.5 rounded-xl text-xs font-black tab-transition ${!isIncome ? 'bg-white text-rose-500 shadow-sm' : 'text-slate-400'}`}>æ”¯å‡º</button>
                                        <button onClick={() => setIsIncome(true)} className={`px-8 py-2.5 rounded-xl text-xs font-black tab-transition ${isIncome ? 'bg-white text-emerald-500 shadow-sm' : 'text-slate-400'}`}>æ”¶å…¥</button>
                                    </div>
                                </div>
                                <input type="number" autoFocus value={amt} onChange={e => setAmt(e.target.value)} placeholder="0" className="w-full text-6xl font-black text-center text-slate-800 mb-8 bg-transparent" />
                                <div className="grid grid-cols-4 gap-3 mb-8 max-h-40 overflow-y-auto no-scrollbar">
                                    {dbData.categories.map(c => (
                                        <button key={c.id} onClick={() => setSelCatId(c.id)} className={`aspect-square rounded-2xl text-2xl flex items-center justify-center tab-transition ${selCatId === c.id ? 'bg-slate-900 shadow-lg scale-110' : 'bg-slate-50'}`}>{c.icon}</button>
                                    ))}
                                </div>
                                <input value={note} onChange={e => setNote(e.target.value)} placeholder="å‚™è¨»..." className="w-full p-4 bg-slate-50 rounded-2xl font-bold mb-6" />
                                <button onClick={() => {
                                    if(!amt) return;
                                    const newTx = { id: 't'+Date.now(), amount: isIncome ? Math.abs(amt) : -Math.abs(amt), note: note || dbData.categories.find(c => c.id === selCatId)?.name, catId: selCatId, user: userName, date: dateStr(selectedDate) };
                                    updateDB({ transactions: [...dbData.transactions, newTx] });
                                    setAmt(''); setNote(''); setShowAdd(false);
                                }} className="w-full py-6 bg-slate-900 text-white rounded-[2rem] font-black shadow-xl active:scale-95 transition-all">ç¢ºèªå„²å­˜</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

