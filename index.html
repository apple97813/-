<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊÉÖ‰æ∂Èõ≤Á´ØË®òÂ∏≥Êú¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        .animate-in { animation: slide-up 0.3s ease-out; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        // Ê®°Êì¨ Firebase Áí∞Â¢ÉËÆäÊï∏ (Áî± Preview Áí∞Â¢ÉÊèê‰æõ)
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'ledger-pro-final';

        // ÂæûÂÖ®ÂüüÂèñÂæó lucide ÂúñÁ§∫ (Á∞°ÂåñÁâà)
        const Icons = {
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            PieChart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.72V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Heart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={props.fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
        };

        const DEFAULT_CATS = [
            { id: 'c1', name: 'È§êÈ£≤', icon: 'üç≤', color: '#fb923c' },
            { id: 'c2', name: '‰∫§ÈÄö', icon: 'üöó', color: '#60a5fa' },
            { id: 'c3', name: 'Â±ÖÂÆ∂', icon: 'üè†', color: '#34d399' },
            { id: 'c4', name: 'Ë≥ºÁâ©', icon: 'üõçÔ∏è', color: '#f472b6' }
        ];

        function App() {
            const [activeTab, setActiveTab] = useState('book');
            const [roomName, setRoomName] = useState(localStorage.getItem('ledger_room') || 'ÊàëÂÄëÁöÑÂÆ∂');
            const [nickname, setNickname] = useState(localStorage.getItem('ledger_nick') || 'Âè¶‰∏ÄÂçä');
            const [data, setData] = useState({ transactions: [], categories: DEFAULT_CATS, recurring: [] });
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [showAdd, setShowAdd] = useState(false);
            const [isIncome, setIsIncome] = useState(false);
            const [amt, setAmt] = useState('');
            const [note, setNote] = useState('');
            const [selCatId, setSelCatId] = useState('c1');

            const dateStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            
            // ËºâÂÖ•Ë≥áÊñô (Âõ†Áí∞Â¢ÉÈôêÂà∂Êö´Áî® localStorage Ê®°Êì¨ÔºåÂª∫Ë≠∞ÈÉ®ÁΩ≤ÂæåÊé•Âõû Firebase)
            useEffect(() => {
                const saved = localStorage.getItem(`ledger_data_${roomName}`);
                if (saved) setData(JSON.parse(saved));
            }, [roomName]);

            // ÂÑ≤Â≠òË≥áÊñô
            const persist = (newData) => {
                setData(newData);
                localStorage.setItem(`ledger_data_${roomName}`, JSON.stringify(newData));
            };

            const saveEntry = () => {
                if (!amt) return;
                const newTx = {
                    id: Date.now().toString(),
                    amount: isIncome ? Math.abs(amt) : -Math.abs(amt),
                    note: note || data.categories.find(c => c.id === selCatId).name,
                    catId: selCatId,
                    user: nickname,
                    date: dateStr(selectedDate)
                };
                const newData = { ...data, transactions: [...data.transactions, newTx] };
                persist(newData);
                setAmt(''); setNote(''); setShowAdd(false);
            };

            const addRecurring = () => {
                const name = prompt("ÂêçÁ®± (Â¶Ç: ÊàøÁßü)");
                const amount = prompt("ÈáëÈ°ç");
                const day = prompt("ÂπæËôüÔºü");
                if(!name || !amount || !day) return;
                const newRec = { id: Date.now(), name, amount: -Math.abs(amount), day: parseInt(day), user: nickname };
                persist({ ...data, recurring: [...(data.recurring || []), newRec] });
            };

            const currentDayTxs = useMemo(() => {
                const normal = data.transactions.filter(t => t.date === dateStr(selectedDate));
                const recur = (data.recurring || []).filter(r => r.day === selectedDate.getDate());
                return [...normal, ...recur.map(r => ({ ...r, isRec: true }))];
            }, [data, selectedDate]);

            const days = useMemo(() => {
                const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
                const first = new Date(y, m, 1).getDay();
                const last = new Date(y, m + 1, 0).getDate();
                const res = [];
                for (let i = 0; i < first; i++) res.push(null);
                for (let i = 1; i <= last; i++) res.push(new Date(y, m, i));
                return res;
            }, [currentMonth]);

            return (
                <div className="max-w-md mx-auto min-h-screen pb-32">
                    <header className="bg-white p-6 pt-12 rounded-b-[3rem] shadow-sm flex justify-between items-center sticky top-0 z-40">
                        <div className="flex items-center gap-3">
                            <div className="w-12 h-12 bg-rose-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-rose-100">
                                <Icons.Heart fill="currentColor" />
                            </div>
                            <div>
                                <h1 className="text-xl font-black text-slate-800">{roomName}</h1>
                                <p className="text-[10px] text-emerald-500 font-bold tracking-widest uppercase">Â∑≤ÂêåÊ≠•Èõ≤Á´Ø</p>
                            </div>
                        </div>
                    </header>

                    <main className="p-4 space-y-6">
                        {activeTab === 'book' && (
                            <>
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm">
                                    <div className="flex justify-between items-center mb-6 px-2 font-black">
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1))}>‚Üê</button>
                                        <span>{currentMonth.getFullYear()}Âπ¥ {currentMonth.getMonth()+1}Êúà</span>
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1))}>‚Üí</button>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 text-center text-[10px] text-slate-300 font-bold mb-2">
                                        {['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'].map(d => <div key={d}>{d}</div>)}
                                    </div>
                                    <div className="grid grid-cols-7 gap-1">
                                        {days.map((d, i) => {
                                            if (!d) return <div key={i} />;
                                            const isSel = dateStr(d) === dateStr(selectedDate);
                                            const hasData = data.transactions.some(t => t.date === dateStr(d)) || data.recurring?.some(r => r.day === d.getDate());
                                            return (
                                                <button key={i} onClick={() => setSelectedDate(d)} className={`aspect-square rounded-2xl flex flex-col items-center justify-center text-sm font-bold relative ${isSel ? 'bg-slate-900 text-white shadow-xl' : 'text-slate-600'}`}>
                                                    {d.getDate()}
                                                    {hasData && !isSel && <div className="absolute bottom-1 w-1.5 h-1.5 bg-rose-500 rounded-full" />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-2">
                                        <h2 className="text-[10px] font-black text-slate-400 tracking-widest">{dateStr(selectedDate)}</h2>
                                        <button onClick={() => setShowAdd(true)} className="bg-rose-500 text-white p-4 rounded-2xl shadow-lg"><Icons.Plus /></button>
                                    </div>
                                    {currentDayTxs.map(t => (
                                        <div key={t.id} className="bg-white p-5 rounded-[2rem] flex justify-between items-center shadow-sm">
                                            <div className="flex items-center gap-4">
                                                <div className="text-2xl">{t.isRec ? 'üîÑ' : (data.categories.find(c => c.id === t.catId)?.icon || 'üí∞')}</div>
                                                <div>
                                                    <p className="font-black text-slate-800 text-sm">{t.note || t.name}</p>
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Áî± {t.user} Ë®òÈåÑ {t.isRec && '| Âõ∫ÂÆöÊî∂ÊîØ'}</p>
                                                </div>
                                            </div>
                                            <p className={`font-black text-lg ${t.amount > 0 ? 'text-emerald-500' : 'text-slate-900'}`}>
                                                {t.amount > 0 ? `+$${t.amount}` : `-$${Math.abs(t.amount)}`}
                                            </p>
                                        </div>
                                    ))}
                                </div>
                            </>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-4">
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-6">
                                    <h3 className="font-black">Âü∫Êú¨Ë®≠ÂÆö</h3>
                                    <input value={nickname} onChange={e => {setNickname(e.target.value); localStorage.setItem('ledger_nick', e.target.value);}} placeholder="‰Ω†ÁöÑÊö±Á®±" className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" />
                                    <input value={roomName} onChange={e => setRoomName(e.target.value)} placeholder="ÊàøÈñìÂêçÁ®±" className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" />
                                </div>
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-black">ÊØèÊúàÂõ∫ÂÆöÊî∂ÊîØ</h3>
                                        <button onClick={addRecurring} className="bg-slate-900 text-white p-2 rounded-xl"><Icons.Plus /></button>
                                    </div>
                                    {data.recurring?.map(r => (
                                        <div key={r.id} className="flex justify-between p-4 bg-slate-50 rounded-2xl">
                                            <span className="font-bold text-sm">{r.name} (ÊØèÊúà{r.day}Ëôü)</span>
                                            <span className="font-black">${Math.abs(r.amount)}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <nav className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl p-2 rounded-full flex gap-1 shadow-2xl z-50 border border-white">
                        {[
                            { id: 'book', icon: Icons.Calendar, label: 'Ë®òÂ∏≥' },
                            { id: 'stats', icon: Icons.PieChart, label: 'ÂàÜÊûê' },
                            { id: 'settings', icon: Icons.Settings, label: 'Ë®≠ÂÆö' }
                        ].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-4 rounded-full transition-all duration-500 ${activeTab === tab.id ? 'bg-slate-900 text-white shadow-lg' : 'text-slate-400'}`}>
                                <tab.icon />
                                {activeTab === tab.id && <span className="text-xs font-black">{tab.label}</span>}
                            </button>
                        ))}
                    </nav>

                    {showAdd && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => setShowAdd(false)} />
                            <div className="relative bg-white w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl animate-in">
                                <div className="flex justify-center mb-6">
                                    <div className="bg-slate-100 p-1 rounded-2xl flex">
                                        <button onClick={() => setIsIncome(false)} className={`px-6 py-2 rounded-xl text-xs font-black ${!isIncome ? 'bg-white text-rose-500 shadow-sm' : 'text-slate-400'}`}>ÊîØÂá∫</button>
                                        <button onClick={() => setIsIncome(true)} className={`px-6 py-2 rounded-xl text-xs font-black ${isIncome ? 'bg-white text-emerald-500 shadow-sm' : 'text-slate-400'}`}>Êî∂ÂÖ•</button>
                                    </div>
                                </div>
                                <input type="number" value={amt} onChange={e => setAmt(e.target.value)} placeholder="0" className="w-full text-6xl font-black text-center outline-none mb-8" />
                                <div className="grid grid-cols-4 gap-3 mb-8">
                                    {data.categories.map(c => (
                                        <button key={c.id} onClick={() => setSelCatId(c.id)} className={`aspect-square rounded-2xl text-2xl flex items-center justify-center ${selCatId === c.id ? 'bg-slate-900 shadow-xl scale-110' : 'bg-slate-50'}`}>{c.icon}</button>
                                    ))}
                                </div>
                                <button onClick={saveEntry} className="w-full py-6 bg-slate-900 text-white rounded-[2rem] font-black shadow-xl">Á¢∫Ë™çÂÑ≤Â≠ò</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

