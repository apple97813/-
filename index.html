<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…ä¾¶é›²ç«¯è¨˜å¸³æœ¬ - å¯¦æ™‚åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .active-tab { background-color: #0f172a; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Firebase åˆå§‹åŒ– (ä½¿ç”¨æ³¨å…¥çš„é…ç½®)
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();
        const appId = window.__app_id || 'our-ledger-v1';

        const DEFAULT_CATS = [
            { id: 'c1', name: 'é¤é£²', icon: 'ğŸ²', color: '#fb923c' },
            { id: 'c2', name: 'äº¤é€š', icon: 'ğŸš—', color: '#60a5fa' },
            { id: 'c3', name: 'å±…å®¶', icon: 'ğŸ ', color: '#34d399' },
            { id: 'c4', name: 'è³¼ç‰©', icon: 'ğŸ›ï¸', color: '#f472b6' }
        ];

        function App() {
            const [activeTab, setActiveTab] = useState('book'); // book, stats, settings
            const [roomName, setRoomName] = useState(localStorage.getItem('ledger_room') || 'æˆ‘çš„å°çª©');
            const [userName, setUserName] = useState(localStorage.getItem('ledger_user') || 'ç”¨æˆ¶A');
            const [filterUser, setFilterUser] = useState('all'); // all, ç”¨æˆ¶A, ç”¨æˆ¶B...
            
            const [dbData, setDbData] = useState({ 
                transactions: [], 
                categories: DEFAULT_CATS, 
                recurring: [] 
            });

            const [selectedDate, setSelectedDate] = useState(new Date());
            const [currentMonth, setCurrentMonth] = useState(new Date());
            const [showAdd, setShowAdd] = useState(false);
            const [loading, setLoading] = useState(true);

            // è¨˜å¸³è¡¨å–®ç‹€æ…‹
            const [amt, setAmt] = useState('');
            const [note, setNote] = useState('');
            const [selCatId, setSelCatId] = useState('c1');
            const [isIncome, setIsIncome] = useState(false);

            // å›ºå®šæ”¶æ”¯è¡¨å–®ç‹€æ…‹ (åµŒå…¥å¼)
            const [recName, setRecName] = useState('');
            const [recAmt, setRecAmt] = useState('');
            const [recDay, setRecDay] = useState('1');

            const dateStr = (d) => `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;

            // 1. åŒ¿åç™»å…¥èˆ‡é›²ç«¯ç›£è½
            useEffect(() => {
                auth.signInAnonymously().then(() => {
                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName);
                    return docRef.onSnapshot(doc => {
                        if (doc.exists) {
                            setDbData(doc.data());
                        } else {
                            docRef.set({ transactions: [], categories: DEFAULT_CATS, recurring: [] });
                        }
                        setLoading(false);
                    });
                });
            }, [roomName]);

            // å–å¾—ç•¶å‰æˆ¿é–“å…§çš„æ‰€æœ‰ç”¨æˆ¶å
            const userList = useMemo(() => {
                const users = new Set(dbData.transactions.map(t => t.user));
                users.add(userName);
                return Array.from(users);
            }, [dbData.transactions, userName]);

            // å„²å­˜è‡³é›²ç«¯
            const updateCloud = async (newData) => {
                const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName);
                await docRef.update(newData);
            };

            const saveEntry = async () => {
                if (!amt) return;
                const newTx = {
                    id: Date.now().toString(),
                    amount: isIncome ? Math.abs(amt) : -Math.abs(amt),
                    note: note || dbData.categories.find(c => c.id === selCatId)?.name || 'æœªåˆ†é¡',
                    catId: selCatId,
                    user: userName,
                    date: dateStr(selectedDate),
                    timestamp: Date.now()
                };
                await updateCloud({
                    transactions: firebase.firestore.FieldValue.arrayUnion(newTx)
                });
                setAmt(''); setNote(''); setShowAdd(false);
            };

            const addRecurring = async () => {
                if (!recName || !recAmt) return;
                const newRec = {
                    id: Date.now().toString(),
                    name: recName,
                    amount: -Math.abs(recAmt), // é è¨­æ”¯å‡º
                    day: parseInt(recDay),
                    user: userName
                };
                await updateCloud({
                    recurring: firebase.firestore.FieldValue.arrayUnion(newRec)
                });
                setRecName(''); setRecAmt('');
            };

            // ç•¶æ—¥é¡¯ç¤ºé‚è¼¯ (åŒ…å«éæ¿¾)
            const displayTxs = useMemo(() => {
                let list = dbData.transactions.filter(t => t.date === dateStr(selectedDate));
                const recur = (dbData.recurring || []).filter(r => r.day === selectedDate.getDate());
                const combined = [...list, ...recur.map(r => ({ ...r, isRec: true }))];
                
                if (filterUser === 'all') return combined;
                return combined.filter(t => t.user === filterUser);
            }, [dbData, selectedDate, filterUser]);

            const days = useMemo(() => {
                const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
                const first = new Date(y, m, 1).getDay();
                const last = new Date(y, m + 1, 0).getDate();
                const res = [];
                for (let i = 0; i < first; i++) res.push(null);
                for (let i = 1; i <= last; i++) res.push(new Date(y, m, i));
                return res;
            }, [currentMonth]);

            if (loading) return <div className="h-screen flex items-center justify-center font-bold text-slate-400">åŒæ­¥é›²ç«¯è³‡æ–™ä¸­...</div>;

            return (
                <div className="max-w-md mx-auto min-h-screen pb-40">
                    <header className="bg-white p-6 pt-12 rounded-b-[3rem] shadow-sm sticky top-0 z-40">
                        <div className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-rose-500 rounded-xl flex items-center justify-center text-white shadow-lg shadow-rose-100">â¤ï¸</div>
                                <h1 className="text-lg font-black">{roomName}</h1>
                            </div>
                            <div className="text-[10px] bg-emerald-100 text-emerald-600 px-3 py-1 rounded-full font-bold">LIVE SYNC</div>
                        </div>

                        {/* ç”¨æˆ¶åˆ‡æ›æŒ‰éˆ• */}
                        <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                            <button 
                                onClick={() => setFilterUser('all')}
                                className={`px-4 py-2 rounded-2xl text-xs font-bold whitespace-nowrap transition-all ${filterUser === 'all' ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-400'}`}
                            >
                                å…¨éƒ¨ç´€éŒ„
                            </button>
                            {userList.map(u => (
                                <button 
                                    key={u}
                                    onClick={() => setFilterUser(u)}
                                    className={`px-4 py-2 rounded-2xl text-xs font-bold whitespace-nowrap transition-all ${filterUser === u ? 'bg-rose-500 text-white' : 'bg-slate-100 text-slate-400'}`}
                                >
                                    {u === userName ? `æˆ‘ (${u})` : u}
                                </button>
                            ))}
                        </div>
                    </header>

                    <main className="p-4 space-y-6">
                        {activeTab === 'book' && (
                            <>
                                <div className="bg-white p-6 rounded-[2.5rem] shadow-sm">
                                    <div className="flex justify-between items-center mb-6 font-black text-slate-700">
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()-1))}>â€¹</button>
                                        <span>{currentMonth.getFullYear()}å¹´ {currentMonth.getMonth()+1}æœˆ</span>
                                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth()+1))}>â€º</button>
                                    </div>
                                    <div className="grid grid-cols-7 gap-1 text-center text-[10px] text-slate-300 font-bold mb-2">
                                        {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d => <div key={d}>{d}</div>)}
                                    </div>
                                    <div className="grid grid-cols-7 gap-1">
                                        {days.map((d, i) => {
                                            if (!d) return <div key={i} />;
                                            const isSel = dateStr(d) === dateStr(selectedDate);
                                            const hasData = dbData.transactions.some(t => t.date === dateStr(d)) || dbData.recurring.some(r => r.day === d.getDate());
                                            return (
                                                <button key={i} onClick={() => setSelectedDate(d)} className={`aspect-square rounded-2xl flex flex-col items-center justify-center text-sm font-bold relative transition-all ${isSel ? 'bg-slate-900 text-white shadow-xl scale-110' : 'text-slate-600 hover:bg-slate-50'}`}>
                                                    {d.getDate()}
                                                    {hasData && !isSel && <div className="absolute bottom-1 w-1.5 h-1.5 bg-rose-500 rounded-full" />}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <div className="flex justify-between items-center px-2">
                                        <h2 className="text-[10px] font-black text-slate-400 tracking-widest uppercase">{dateStr(selectedDate)}</h2>
                                        <button onClick={() => setShowAdd(true)} className="bg-rose-500 text-white p-4 rounded-2xl shadow-xl active:scale-90 transition-transform">ï¼‹ æ–°å¢è¨˜å¸³</button>
                                    </div>
                                    {displayTxs.length === 0 ? (
                                        <div className="py-12 text-center text-slate-300 font-bold text-xs italic">ç„¡ç´€éŒ„</div>
                                    ) : (
                                        displayTxs.map(t => (
                                            <div key={t.id} className="bg-white p-5 rounded-[2rem] flex justify-between items-center shadow-sm">
                                                <div className="flex items-center gap-4">
                                                    <div className="text-2xl w-12 h-12 bg-slate-50 rounded-2xl flex items-center justify-center">
                                                        {t.isRec ? 'ğŸ”„' : (dbData.categories.find(c => c.id === t.catId)?.icon || 'ğŸ’°')}
                                                    </div>
                                                    <div>
                                                        <p className="font-black text-slate-800 text-sm">{t.note || t.name}</p>
                                                        <p className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">ç”± {t.user} è¨˜éŒ„ {t.isRec && '| å›ºå®š'}</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className={`font-black text-lg ${t.amount > 0 ? 'text-emerald-500' : 'text-slate-900'}`}>
                                                        {t.amount > 0 ? `+$${t.amount}` : `-$${Math.abs(t.amount)}`}
                                                    </p>
                                                    {!t.isRec && <button onClick={async () => {
                                                        const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName);
                                                        await docRef.update({ transactions: dbData.transactions.filter(tx => tx.id !== t.id) });
                                                    }} className="text-[9px] text-rose-300 font-bold">åˆªé™¤</button>}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </>
                        )}

                        {activeTab === 'settings' && (
                            <div className="space-y-6">
                                {/* å€‹äººè³‡æ–™ */}
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-6">
                                    <h3 className="font-black text-slate-800">æˆ¿é–“èˆ‡ç”¨æˆ¶è¨­å®š</h3>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 ml-2">æˆ‘çš„æš±ç¨± (å€åˆ†è¨˜å¸³è€…)</label>
                                        <input value={userName} onChange={e => {setUserName(e.target.value); localStorage.setItem('ledger_user', e.target.value);}} className="w-full p-4 bg-slate-50 rounded-2xl font-bold mt-1 outline-none" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-black text-slate-400 ml-2">æˆ¿é–“åç¨± (å¦ä¸€æ”¯æ‰‹æ©Ÿè¼¸å…¥ä¸€æ¨£çš„å³å¯åŒæ­¥)</label>
                                        <input value={roomName} onChange={e => setRoomName(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl font-bold mt-1 outline-none border-2 border-rose-100 focus:border-rose-500 transition-all" />
                                    </div>
                                </div>

                                {/* æ¯æœˆå›ºå®šæ”¶æ”¯ - åµŒå…¥å¼è¡¨å–® */}
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-6">
                                    <h3 className="font-black text-slate-800">æ–°å¢æ¯æœˆå›ºå®šæ”¯å‡º</h3>
                                    <div className="grid grid-cols-2 gap-2">
                                        <input value={recName} onChange={e => setRecName(e.target.value)} placeholder="é …ç›®(å¦‚:æˆ¿ç§Ÿ)" className="p-4 bg-slate-50 rounded-2xl font-bold text-sm outline-none" />
                                        <input type="number" value={recAmt} onChange={e => setRecAmt(e.target.value)} placeholder="é‡‘é¡" className="p-4 bg-slate-50 rounded-2xl font-bold text-sm outline-none" />
                                    </div>
                                    <div className="flex gap-2 items-center">
                                        <span className="text-xs font-bold text-slate-400 whitespace-nowrap">æ¯æœˆå¹¾è™Ÿï¼Ÿ</span>
                                        <input type="number" min="1" max="31" value={recDay} onChange={e => setRecDay(e.target.value)} className="w-full p-4 bg-slate-50 rounded-2xl font-bold outline-none" />
                                        <button onClick={addRecurring} className="bg-slate-900 text-white px-6 py-4 rounded-2xl font-black text-sm">æ–°å¢</button>
                                    </div>
                                    <div className="space-y-2 pt-4">
                                        {dbData.recurring?.map(r => (
                                            <div key={r.id} className="flex justify-between items-center p-4 bg-slate-50 rounded-2xl">
                                                <span className="font-bold text-xs">{r.name} (æ¯æœˆ{r.day}è™Ÿ) - ${Math.abs(r.amount)}</span>
                                                <button onClick={async () => {
                                                    const docRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('rooms').doc(roomName);
                                                    await docRef.update({ recurring: dbData.recurring.filter(rec => rec.id !== r.id) });
                                                }} className="text-rose-400 font-bold text-xs">åˆªé™¤</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* è‡ªå®šç¾©åˆ†é¡ç®¡ç† */}
                                <div className="bg-white p-8 rounded-[3rem] shadow-sm space-y-6">
                                    <h3 className="font-black text-slate-800">ç®¡ç†è‡ªå®šç¾©åˆ†é¡</h3>
                                    <div className="grid grid-cols-2 gap-4 mb-4">
                                        {dbData.categories.map(c => (
                                            <div key={c.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-2xl">
                                                <span className="text-sm font-bold">{c.icon} {c.name}</span>
                                                <button onClick={async () => {
                                                    await updateCloud({ categories: dbData.categories.filter(cat => cat.id !== c.id) });
                                                }} className="text-rose-300">Ã—</button>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={async () => {
                                        const name = prompt("åˆ†é¡åç¨±ï¼Ÿ");
                                        const icon = prompt("Emoji åœ–ç¤ºï¼Ÿ");
                                        if(name && icon) {
                                            await updateCloud({ 
                                                categories: [...dbData.categories, { id: 'c'+Date.now(), name, icon, color: '#94a3b8' }] 
                                            });
                                        }
                                    }} className="w-full py-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs">ï¼‹ å¢åŠ æ–°åˆ†é¡</button>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* å°è¦½åˆ— */}
                    <nav className="fixed bottom-10 left-1/2 -translate-x-1/2 bg-white/90 backdrop-blur-xl p-2 rounded-full flex gap-1 shadow-2xl z-50 border border-white">
                        {[
                            { id: 'book', label: 'è¨˜å¸³', icon: 'ğŸ“…' },
                            { id: 'stats', label: 'åˆ†æ', icon: 'ğŸ“Š' },
                            { id: 'settings', label: 'è¨­å®š', icon: 'âš™ï¸' }
                        ].map(tab => (
                            <button 
                                key={tab.id} 
                                onClick={() => setActiveTab(tab.id)} 
                                className={`flex items-center gap-2 px-6 py-4 rounded-full transition-all duration-500 ${activeTab === tab.id ? 'active-tab' : 'text-slate-400'}`}
                            >
                                <span>{tab.icon}</span>
                                {activeTab === tab.id && <span className="text-xs font-black">{tab.label}</span>}
                            </button>
                        ))}
                    </nav>

                    {/* è¨˜å¸³å½ˆçª— */}
                    {showAdd && (
                        <div className="fixed inset-0 z-[100] flex items-end justify-center p-4">
                            <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-md" onClick={() => setShowAdd(false)} />
                            <div className="relative bg-white w-full max-w-sm rounded-[3.5rem] p-10 shadow-2xl animate-in">
                                <div className="flex justify-center mb-6">
                                    <div className="bg-slate-100 p-1 rounded-2xl flex">
                                        <button onClick={() => setIsIncome(false)} className={`px-6 py-2 rounded-xl text-xs font-black ${!isIncome ? 'bg-white text-rose-500 shadow-sm' : 'text-slate-400'}`}>æ”¯å‡º</button>
                                        <button onClick={() => setIsIncome(true)} className={`px-6 py-2 rounded-xl text-xs font-black ${isIncome ? 'bg-white text-emerald-500 shadow-sm' : 'text-slate-400'}`}>æ”¶å…¥</button>
                                    </div>
                                </div>
                                <input type="number" autoFocus value={amt} onChange={e => setAmt(e.target.value)} placeholder="0" className="w-full text-6xl font-black text-center outline-none mb-8" />
                                <div className="grid grid-cols-4 gap-3 mb-8">
                                    {dbData.categories.map(c => (
                                        <button key={c.id} onClick={() => setSelCatId(c.id)} className={`aspect-square rounded-2xl text-2xl flex items-center justify-center transition-all ${selCatId === c.id ? 'bg-slate-900 shadow-xl scale-110' : 'bg-slate-50'}`}>{c.icon}</button>
                                    ))}
                                </div>
                                <input value={note} onChange={e => setNote(e.target.value)} placeholder="å‚™è¨»..." className="w-full p-4 bg-slate-50 rounded-2xl font-bold mb-6 outline-none" />
                                <button onClick={saveEntry} className="w-full py-6 bg-slate-900 text-white rounded-[2rem] font-black shadow-xl active:scale-95">ç¢ºèªå„²å­˜</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

